---
title: "MCStd Trick 1: R-Squared"
author: "Ivan Jacob Agaloos Pesigan"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{MCStd Trick 1: R-Squared}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r}
#| include = FALSE
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r}
#| include = FALSE
set.seed(42)
```

The Monte Carlo method is used to generate confidence intervals
for $R^{2}$ and adjusted $R^{2}$ $\left( \bar{R}^{2}\right)$
in a simple mediation model.
In the simple mediation model,
variable `X` has an effect on variable `Y`,
through a mediating variable `M`.
This mediating or indirect effect
is a product of path coefficients from the fitted model.

![The Simple Mediation Model](https://raw.githubusercontent.com/jeksterslab/semmcci/main/latexsrc/figures/png/simple.png)

```{r}
#| message = FALSE
library(semmcci)
library(lavaan)
```

## Data

```{r}
n <- 1000
a <- 0.50
b <- 0.50
cp <- 0.25
s2_em <- 1 - a^2
s2_ey <- 1 - cp^2 - a^2 * b^2 - b^2 * s2_em - 2 * cp * a * b
em <- rnorm(n = n, mean = 0, sd = sqrt(s2_em))
ey <- rnorm(n = n, mean = 0, sd = sqrt(s2_ey))
X <- rnorm(n = n)
M <- a * X + em
Y <- cp * X + b * M + ey
df <- data.frame(X, M, Y)
```

## Model Specification

$R^{2}$ and $\bar{R}^{2}$
are defined using the `:=` operator
in the `lavaan` model syntax
using the following equations

\begin{equation}
    R^{2}
    =
    1 - \sigma^{2}_{\mathrm{standardized}}
\end{equation}

\begin{equation}
    \bar{R}^{2}
    =
    1
    -
    \left(
    \frac{n - 1}{n - p - 1}
    \right)
    \left(
    1 - R^2
    \right)
\end{equation}

\noindent where $\sigma^{2}_{\mathrm{standardized}}$
is the standardized error variance,
$n$ is the sample size,
and $p$ is the number of regressor variables.

```{r}
model <- "
  Y ~ cp * X + b * M
  M ~ a * X
  M ~~ s2_em * M
  Y ~~ s2_ey * Y
  rsqm := 1 - s2_em
  rsqy := 1 - s2_ey
  rsqm_bar := 1 - (
    (1000 - 1) / (1000 - 1 - 1)
  ) * (
    1 - rsqm
  )
  rsqy_bar := 1 - (
    (1000 - 1) / (1000 - 2 - 1)
  ) * (
    1 - rsqy
  )
"
```

## Model Fitting

We can now fit the model using the `sem()` function from `lavaan`.

```{r}
fit <- sem(data = df, model = model)
```

## Monte Carlo Confidence Intervals

The `fit` `lavaan` object can then be passed to the `MC()` function
and then to the `MCStd()` function to generate Monte Carlo confidence intervals.

> **Note:** The parameterization of $R^{2}$ and $\bar{R}^{2}$ above
should only be interpreted using the output of the `MCStd()` function
since the input in the functions defined by `:=`
require standardized estimates.

```{r}
MCStd(MC(fit, R = 20000L, alpha = c(0.001, 0.01, 0.05)))
```
