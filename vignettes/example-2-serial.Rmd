---
title: "Example 2: The Serial Mediation Model"
author: "Ivan Jacob Agaloos Pesigan"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{Example 2: The Serial Mediation Model}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

This is an example of a serial mediation model with two mediators
where `X` is the predictor, `M1` is the first mediator, `M2` is the second mediator,
and `Y` is the dependent variable.

```{r, message = FALSE}
library(semmcci)
library(lavaan)
```

## Data

```{r}
n <- 1000
X <- rnorm(n = n)
M1 <- 0.50 * X + rnorm(n = n)
M2 <- 0.15 * X + 0.50 * M1 + rnorm(n = n)
Y <- 0.10 * X + 0.05 * M1 + 0.50 * M2 + rnorm(n = n)
data <- data.frame(X, M1, M2, Y)
```

## Model Specification

We can define several indirect effects in this example:

  - $X \rightarrow M1 \rightarrow M2 \rightarrow Y$
  - $X \rightarrow M1 \rightarrow M2$
  - $X \rightarrow M1 \rightarrow Y$
  - $M1 \rightarrow M2 \rightarrow Y$

These indirect effects are defined using the `:=` operator
in the `lavaan` model syntax.

```{r}
model <- "
  Y ~ cp * X + b1 * M1 + b2 * M2
  M2 ~ a2 * X + k * M1
  M1 ~ a1 * X
  # X -> M1 -> M2 -> Y
  a1kb2 := a1 * k * b2
  # X -> M1 -> M2
  a1k := a1 * k
  # X -> M1 -> Y
  a2b2 := a2 * b2
  # M1 -> M2 -> Y
  kb2 := k * b2
"
```

## Model Fitting

```{r}
fit <- sem(data = data, model = model)
```

## Monte Carlo Confidence Intervals

The `fit` `lavaan` object can then be passed to the `mc()` function from `semmcci`
to generate Monte Carlo confidence intervals.

> **Note:** The argument `par = TRUE` can be specified to use multiple cores for a faster implementation for both `mc()` and `mc_std()`.
> The number of cores to use can be specified with `ncores`.

```{r}
mc(
  fit,
  R = 100L, # use a large value e.g., 20000L for actual research
  alpha = c(0.001, 0.01, 0.05)
)
```

## Standardized Monte Carlo Confidence Intervals

Standardized Monte Carlo Confidence intervals can be generated by passing the result of the `mc()` function to `mc_std()`.

> **Note:** We recommend setting `fixed.x = FALSE` when generating standardized estimates and confidence intervals to model the variance of the predictor/s.

```{r}
fit <- sem(data = data, model = model, fixed.x = FALSE)
unstd <- mc(
  fit,
  R = 100L, # use a large value e.g., 20000L for actual research
  alpha = c(0.001, 0.01, 0.05)
)
mc_std(unstd)
```
