---
title: "Examples"
author: "Ivan Jacob Agaloos Pesigan"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{Examples}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

This vignette presents three examples
of generating Monte Carlo confidence intervals
for parameters defined using the `:=` operator
in the structural equation modeling software `lavaan`.
The first example involves a simple mediation model.
The second example involves a serial mediation model.
The third example involves missing data.

```{r}
library(semmcci)
library(lavaan)
```

## Example 1: The Simple Mediation Model

This is an example of a simple mediation model
where `x` is the predictor, `m` is the mediator,
and `y` is the dependent variable.

### Data

```{r}
n <- 1000
x <- rnorm(n = n)
m <- 0.50 * x + rnorm(n = n)
y <- 0.25 * x + 0.50 * m + rnorm(n = n)
data <- data.frame(
  x,
  m,
  y
)
```

### Model Specification

The indirect effect is defined by the product of the slopes
of paths `x` to `m` labelled as `a` and `m` to `y` labelled as `b`.
In this example, we are interested in the confidence intervals of `ab`
defined as the product of `a` and `b` using the `:=` operator
in the `lavaan` model syntax.

```{r}
model <- "
  y ~ cp * x + b * m
  m ~ a * x
  indirect := a * b
  direct := cp 
  total := cp + (a * b)
"
```

### Model Fitting

We can now fit the model using the `sem` function from `lavaan`.

```{r}
fit <- sem(
  data = data,
  model = model
)
summary(fit)
```

### Monte Carlo Confidence Intervals

The `fit` `lavaan` object can then be passed to the `mc` function from `semmcci`
to generate Monte Carlo confidence intervals for defined parameters.

```{r}
mc(
  object = fit,
  R = 20000L,
  alpha = c(0.001, 0.01, 0.05),
  plot = TRUE
)
```

## Example 2: The Serial Mediation Model

This is an example of a serial mediation model with two mediators
where `x` is the predictor, `m1` is the first mediator, `m2` is the second mediator,
and `y` is the dependent variable.

### Data

```{r}
n <- 1000
x <- rnorm(n = n)
m1 <- 0.50 * x + rnorm(n = n)
m2 <- 0.15 * x + 0.50 * m1 + rnorm(n = n)
y <- 0.10 * x + 0.05 * m1 + 0.50 * m2 + rnorm(n = n)
data <- data.frame(
  x,
  m1,
  m2,
  y
)
```

### Model Specification

We can define several indirect effects in this example:

  - $x \rightarrow m1 \rightarrow m2 \rightarrow y$
  - $x \rightarrow m1 \rightarrow m2$
  - $x \rightarrow m1 \rightarrow y$
  - $m1 \rightarrow m2 \rightarrow y$

These indirect effects are defined using the `:=` operator
in the `lavaan` model syntax.

```{r}
model <- "
  y ~ cp * x + b1 * m1 + b2 * m2
  m2 ~ a2 * x + k * m1
  m1 ~ a1 * x
  # x -> m1 -> m2 -> y
  a1kb2 := a1 * k * b2
  # x -> m1 -> m2
  a1k := a1 * k
  # x -> m1 -> y
  a2b2 := a2 * b2
  # m1 -> m2 -> y
  kb2 := k * b2
"
```

### Model Fitting

```{r}
fit <- sem(
  data = data,
  model = model
)
summary(fit)
```

### Monte Carlo Confidence Intervals

```{r}
mc(
  object = fit,
  R = 20000L,
  alpha = c(0.001, 0.01, 0.05),
  plot = TRUE
)
```

## Example 3: Missing Data

This is an example of a simple mediation model with missing data.

### Data

```{r}
n <- 1000
x <- rnorm(n = n)
m <- 0.50 * x + rnorm(n = n)
y <- 0.25 * x + 0.50 * m + rnorm(n = n)
data <- data.frame(
  x,
  m,
  y
)

# Create data set with missing values.

miss <- sample(1:dim(data)[1], 300)
data[miss[1:100], "x"] <- NA
data[miss[101:200], "m"] <- NA
data[miss[201:300], "y"] <- NA
```

### Model Specification

```{r}
model <- "
  y ~ cp * x + b * m
  m ~ a * x
  ab := a * b
"
```

### Model Fitting

We are using `missing = "fiml"` to handle missing data in `lavaan`.
Since there are missing values in `x`, we also set `fixed.x = FALSE`.

```{r}
fit <- sem(
  data = data,
  model = model,
  missing = "fiml",
  fixed.x = FALSE
)
summary(fit)
```

### Monte Carlo Confidence Intervals

```{r}
mc(
  object = fit,
  R = 20000L,
  alpha = c(0.001, 0.01, 0.05),
  plot = TRUE
)
```
