---
title: "Benchmark: Comparing the Monte Carlo Method with Nonparametric Bootstrapping"
author: "Ivan Jacob Agaloos Pesigan"
date: "2022-09-20"
output:
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{Benchmark: Comparing the Monte Carlo Method with Nonparametric Bootstrapping}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---









We compare the Monte Carlo (MC) method with nonparametric bootstrapping (NB) using the simple mediation model with missing data.
One advantage of MC over NB is speed.
This is because the model is only fitted once in MC whereas it is fitted many times in NB.


```r
library(semmcci)
library(lavaan)
library(microbenchmark)
```

## Arguments




|Variables |Values |Notes                               |
|:---------|:------|:-----------------------------------|
|R         |5000   |Number of Monte Carlo replications. |
|B         |5000   |Number of bootstrap samples.        |

## Data


```r
n <- 1000
X <- rnorm(n = n)
M <- 0.50 * X + rnorm(n = n)
Y <- 0.25 * X + 0.50 * M + rnorm(n = n)
data <- data.frame(X, M, Y)

# Create data set with missing values.

miss <- sample(1:dim(data)[1], 300)
data[miss[1:100], "X"] <- NA
data[miss[101:200], "M"] <- NA
data[miss[201:300], "Y"] <- NA
```

## Model Specification

The indirect effect is defined by the product of the slopes
of paths `X` to `M` labeled as `a` and `M` to `Y` labeled as `b`.
In this example, we are interested in the confidence intervals of `indirect`
defined as the product of `a` and `b` using the `:=` operator
in the `lavaan` model syntax.


```r
model <- "
  Y ~ cp * X + b * M
  M ~ a * X
  indirect := a * b
  direct := cp
  total := cp + (a * b)
"
```

## Model Fitting

We can now fit the model using the `sem()` function from `lavaan`.
We are using `missing = "fiml"` to handle missing data in `lavaan`.
Since there are missing values in `x`, we also set `fixed.x = FALSE`.


```r
fit <- sem(data = data, model = model, missing = "fiml", fixed.x = FALSE)
```

## Monte Carlo Confidence Intervals

The `fit` `lavaan` object can then be passed to the `MC()` function from `semmcci`
to generate Monte Carlo confidence intervals.


```r
MC(fit, R = 500, alpha = c(0.001, 0.01, 0.05))
#> Monte Carlo Confidence Intervals
#>                est      se   R    0.05%     0.5%     2.5%   97.5%   99.5%
#> cp        0.228603 0.04103 500  0.12311  0.13107  0.15034 0.30611 0.33222
#> b         0.489527 0.03644 500  0.38196  0.39722  0.41750 0.56146 0.58017
#> a         0.503900 0.03363 500  0.41693  0.41910  0.43918 0.57214 0.58926
#> Y~~Y      1.066404 0.05193 500  0.90242  0.93575  0.96596 1.16567 1.19558
#> M~~M      0.989621 0.04796 500  0.86033  0.87209  0.90134 1.08762 1.10827
#> X~~X      1.033466 0.04973 500  0.91899  0.92728  0.93522 1.12848 1.14884
#> Y~1       0.008956 0.03492 500 -0.09641 -0.08019 -0.05791 0.07645 0.09004
#> M~1      -0.012557 0.03114 500 -0.13343 -0.08618 -0.07022 0.05012 0.06085
#> X~1      -0.029413 0.03433 500 -0.12950 -0.11639 -0.09999 0.04233 0.06062
#> indirect  0.246673 0.02466 500  0.17043  0.18349  0.19924 0.29046 0.31097
#> direct    0.228603 0.04103 500  0.12311  0.13107  0.15034 0.30611 0.33222
#> total     0.475276 0.04016 500  0.36430  0.37695  0.39523 0.54702 0.57434
#>           99.95%
#> cp       0.35050
#> b        0.58331
#> a        0.60284
#> Y~~Y     1.20160
#> M~~M     1.13994
#> X~~X     1.18022
#> Y~1      0.11415
#> M~1      0.09204
#> X~1      0.07317
#> indirect 0.31746
#> direct   0.35050
#> total    0.61957
```

## Nonparametric Bootstrap Confidence Intervals

Nonparametric bootstrap confidence intervals can be generated in `lavaan` using the following.


```r
parameterEstimates(
  sem(
    data = data,
    model = model,
    missing = "fiml",
    fixed.x = FALSE,
    se = "bootstrap",
    bootstrap = 500
  )
)
#>         lhs op      rhs    label    est    se      z pvalue ci.lower ci.upper
#> 1         Y  ~        X       cp  0.229 0.042  5.464  0.000    0.142    0.311
#> 2         Y  ~        M        b  0.490 0.035 13.929  0.000    0.420    0.556
#> 3         M  ~        X        a  0.504 0.034 14.816  0.000    0.435    0.566
#> 4         Y ~~        Y           1.066 0.050 21.463  0.000    0.968    1.158
#> 5         M ~~        M           0.990 0.049 20.313  0.000    0.888    1.086
#> 6         X ~~        X           1.033 0.049 20.970  0.000    0.944    1.140
#> 7         Y ~1                    0.009 0.036  0.246  0.806   -0.057    0.081
#> 8         M ~1                   -0.013 0.033 -0.379  0.705   -0.075    0.052
#> 9         X ~1                   -0.029 0.035 -0.847  0.397   -0.101    0.034
#> 10 indirect :=      a*b indirect  0.247 0.024 10.260  0.000    0.198    0.294
#> 11   direct :=       cp   direct  0.229 0.042  5.458  0.000    0.142    0.311
#> 12    total := cp+(a*b)    total  0.475 0.040 11.950  0.000    0.396    0.552
```

## Benchmark




```r
benchmark01 <- microbenchmark(
  MC = {
    fit <- sem(
      data = data,
      model = model,
      missing = "fiml",
      fixed.x = FALSE
    )
    MC(
      fit,
      R = R
    )
  },
  NB = sem(
    data = data,
    model = model,
    missing = "fiml",
    fixed.x = FALSE,
    se = "bootstrap",
    bootstrap = B
  ),
  times = 10
)
```

### Summary of Benchmark Results


```r
summary(benchmark01)
#>   expr         min          lq        mean      median          uq         max
#> 1   MC    165.2084    167.3945    175.2107    173.3639    183.1616    188.5087
#> 2   NB 118004.1084 118418.5625 118523.1858 118557.4567 118771.0982 118970.6300
#>   neval
#> 1    10
#> 2    10
```

### Summary of Benchmark Results Relative to the Faster Method


```r
summary(benchmark01, unit = "relative")
#>   expr      min       lq     mean   median       uq      max neval
#> 1   MC   1.0000   1.0000   1.0000   1.0000   1.0000   1.0000    10
#> 2   NB 714.2742 707.4221 676.4609 683.8649 648.4498 631.1148    10
```

## Benchmark - Monte Carlo Method with Precalculated Estimates




```r
benchmark02 <- microbenchmark(
  MC = MC(
    fit,
    R = R
  ),
  NB = sem(
    data = data,
    model = model,
    missing = "fiml",
    fixed.x = FALSE,
    se = "bootstrap",
    bootstrap = B
  ),
  times = 10
)
```

### Summary of Benchmark Results


```r
summary(benchmark02)
#>   expr         min         lq        mean      median          uq        max
#> 1   MC    157.6788    166.287    177.2849    175.7493    185.0847    210.917
#> 2   NB 118627.1229 118829.004 119073.5468 119120.7629 119281.5891 119440.962
#>   neval
#> 1    10
#> 2    10
```

### Summary of Benchmark Results Relative to the Faster Method


```r
summary(benchmark02, unit = "relative")
#>   expr      min       lq     mean   median       uq      max neval
#> 1   MC   1.0000   1.0000   1.0000   1.0000   1.0000   1.0000    10
#> 2   NB 752.3341 714.6019 671.6509 677.7881 644.4704 566.2937    10
```
