---
title: "Benchmark: Comparing the Monte Carlo Method with Nonparametric Bootstrapping"
author: "Ivan Jacob Agaloos Pesigan"
date: "2022-10-04"
output:
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{Benchmark: Comparing the Monte Carlo Method with Nonparametric Bootstrapping}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---









We compare the Monte Carlo (MC) method with nonparametric bootstrapping (NB) using the simple mediation model with missing data.
One advantage of MC over NB is speed.
This is because the model is only fitted once in MC whereas it is fitted many times in NB.


```r
library(semmcci)
library(lavaan)
library(microbenchmark)
```

## Data


```r
n <- 1000
X <- rnorm(n = n)
M <- 0.50 * X + rnorm(n = n)
Y <- 0.25 * X + 0.50 * M + rnorm(n = n)
data <- data.frame(X, M, Y)

# Create data set with missing values.

miss <- sample(1:dim(data)[1], 300)
data[miss[1:100], "X"] <- NA
data[miss[101:200], "M"] <- NA
data[miss[201:300], "Y"] <- NA
```

## Model Specification

The indirect effect is defined by the product of the slopes
of paths `X` to `M` labeled as `a` and `M` to `Y` labeled as `b`.
In this example, we are interested in the confidence intervals of `indirect`
defined as the product of `a` and `b` using the `:=` operator
in the `lavaan` model syntax.


```r
model <- "
  Y ~ cp * X + b * M
  M ~ a * X
  indirect := a * b
  direct := cp
  total := cp + (a * b)
"
```

## Model Fitting

We can now fit the model using the `sem()` function from `lavaan`.
We are using `missing = "fiml"` to handle missing data in `lavaan`.
Since there are missing values in `x`, we also set `fixed.x = FALSE`.


```r
fit <- sem(data = data, model = model, missing = "fiml", fixed.x = FALSE)
```

## Monte Carlo Confidence Intervals

The `fit` `lavaan` object can then be passed to the `MC()` function from `semmcci`
to generate Monte Carlo confidence intervals.


```r
MC(fit, R = 500, alpha = c(0.001, 0.01, 0.05))
#> Monte Carlo Confidence Intervals
#>              est     se   R   0.05%    0.5%    2.5%  97.5%  99.5% 99.95%
#> cp        0.2286 0.0410 500  0.1231  0.1311  0.1503 0.3061 0.3322 0.3505
#> b         0.4895 0.0364 500  0.3820  0.3972  0.4175 0.5615 0.5802 0.5833
#> a         0.5039 0.0336 500  0.4169  0.4191  0.4392 0.5721 0.5893 0.6028
#> Y~~Y      1.0664 0.0519 500  0.9024  0.9358  0.9660 1.1657 1.1956 1.2016
#> M~~M      0.9896 0.0480 500  0.8603  0.8721  0.9013 1.0876 1.1083 1.1399
#> X~~X      1.0335 0.0497 500  0.9190  0.9273  0.9352 1.1285 1.1488 1.1802
#> Y~1       0.0090 0.0349 500 -0.0964 -0.0802 -0.0579 0.0764 0.0900 0.1142
#> M~1      -0.0126 0.0311 500 -0.1334 -0.0862 -0.0702 0.0501 0.0608 0.0920
#> X~1      -0.0294 0.0343 500 -0.1295 -0.1164 -0.1000 0.0423 0.0606 0.0732
#> indirect  0.2467 0.0247 500  0.1704  0.1835  0.1992 0.2905 0.3110 0.3175
#> direct    0.2286 0.0410 500  0.1231  0.1311  0.1503 0.3061 0.3322 0.3505
#> total     0.4753 0.0402 500  0.3643  0.3769  0.3952 0.5470 0.5743 0.6196
```

## Nonparametric Bootstrap Confidence Intervals

Nonparametric bootstrap confidence intervals can be generated in `lavaan` using the following.


```r
parameterEstimates(
  sem(
    data = data,
    model = model,
    missing = "fiml",
    fixed.x = FALSE,
    se = "bootstrap",
    bootstrap = 500
  )
)
#>         lhs op      rhs    label    est    se      z pvalue ci.lower ci.upper
#> 1         Y  ~        X       cp  0.229 0.042  5.464  0.000    0.142    0.311
#> 2         Y  ~        M        b  0.490 0.035 13.929  0.000    0.420    0.556
#> 3         M  ~        X        a  0.504 0.034 14.816  0.000    0.435    0.566
#> 4         Y ~~        Y           1.066 0.050 21.463  0.000    0.968    1.158
#> 5         M ~~        M           0.990 0.049 20.313  0.000    0.888    1.086
#> 6         X ~~        X           1.033 0.049 20.970  0.000    0.944    1.140
#> 7         Y ~1                    0.009 0.036  0.246  0.806   -0.057    0.081
#> 8         M ~1                   -0.013 0.033 -0.379  0.705   -0.075    0.052
#> 9         X ~1                   -0.029 0.035 -0.847  0.397   -0.101    0.034
#> 10 indirect :=      a*b indirect  0.247 0.024 10.260  0.000    0.198    0.294
#> 11   direct :=       cp   direct  0.229 0.042  5.458  0.000    0.142    0.311
#> 12    total := cp+(a*b)    total  0.475 0.040 11.950  0.000    0.396    0.552
```

## Benchmark

### Arguments




|Variables |Values |Notes                               |
|:---------|:------|:-----------------------------------|
|R         |5000   |Number of Monte Carlo replications. |
|B         |5000   |Number of bootstrap samples.        |




```r
benchmark01 <- microbenchmark(
  MC = {
    fit <- sem(
      data = data,
      model = model,
      missing = "fiml",
      fixed.x = FALSE
    )
    MC(
      fit,
      R = R
    )
  },
  NB = sem(
    data = data,
    model = model,
    missing = "fiml",
    fixed.x = FALSE,
    se = "bootstrap",
    bootstrap = B
  ),
  times = 10
)
```

### Summary of Benchmark Results


```r
summary(benchmark01)
#>   expr         min          lq       mean      median          uq         max
#> 1   MC    176.3885    185.6797    207.241    206.7558    227.7189    232.4513
#> 2   NB 146191.7828 151968.2910 155967.583 156755.3368 159715.0243 165690.5521
#>   neval
#> 1    10
#> 2    10
```

### Summary of Benchmark Results Relative to the Faster Method


```r
summary(benchmark01, unit = "relative")
#>   expr      min       lq     mean   median       uq      max neval
#> 1   MC   1.0000   1.0000   1.0000   1.0000   1.0000   1.0000    10
#> 2   NB 828.8058 818.4433 752.5905 758.1667 701.3692 712.7968    10
```

## Benchmark - Monte Carlo Method with Precalculated Estimates




```r
benchmark02 <- microbenchmark(
  MC = MC(
    fit,
    R = R
  ),
  NB = sem(
    data = data,
    model = model,
    missing = "fiml",
    fixed.x = FALSE,
    se = "bootstrap",
    bootstrap = B
  ),
  times = 10
)
```

### Summary of Benchmark Results


```r
summary(benchmark02, unit = "ms")
#>   expr         min          lq        mean      median          uq         max
#> 1   MC    183.9912    199.6924    216.0503    223.7228    225.0314    261.4742
#> 2   NB 148183.0497 150792.1888 153965.2225 152093.6968 157028.4744 162718.7650
#>   neval
#> 1    10
#> 2    10
```

### Summary of Benchmark Results Relative to the Faster Method


```r
summary(benchmark02, unit = "relative")
#>   expr     min       lq     mean   median      uq      max neval
#> 1   MC   1.000   1.0000   1.0000   1.0000   1.000   1.0000    10
#> 2   NB 805.381 755.1223 712.6361 679.8311 697.807 622.3128    10
```
