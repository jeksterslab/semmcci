---
title: "Benchmark: Comparing the Monte Carlo Method with Nonparametric Bootstrapping"
author: "Ivan Jacob Agaloos Pesigan"
date: "2022-10-14"
output:
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{Benchmark: Comparing the Monte Carlo Method with Nonparametric Bootstrapping}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---









We compare the Monte Carlo (MC) method with nonparametric bootstrapping (NB) using the simple mediation model with missing data.
One advantage of MC over NB is speed.
This is because the model is only fitted once in MC whereas it is fitted many times in NB.


```r
library(semmcci)
library(lavaan)
library(microbenchmark)
```

## Data


```r
n <- 1000
a <- 0.50
b <- 0.50
cp <- 0.25
s2_em <- 1 - a^2
s2_ey <- 1 - cp^2 - a^2 * b^2 - b^2 * s2_em - 2 * cp * a * b
em <- rnorm(n = n, mean = 0, sd = sqrt(s2_em))
ey <- rnorm(n = n, mean = 0, sd = sqrt(s2_ey))
X <- rnorm(n = n)
M <- a * X + em
Y <- cp * X + b * M + ey
df <- data.frame(X, M, Y)

# Create data set with missing values.

miss <- sample(1:dim(df)[1], 300)
df[miss[1:100], "X"] <- NA
df[miss[101:200], "M"] <- NA
df[miss[201:300], "Y"] <- NA
```

## Model Specification

The indirect effect is defined by the product of the slopes
of paths `X` to `M` labeled as `a` and `M` to `Y` labeled as `b`.
In this example, we are interested in the confidence intervals of `indirect`
defined as the product of `a` and `b` using the `:=` operator
in the `lavaan` model syntax.


```r
model <- "
  Y ~ cp * X + b * M
  M ~ a * X
  indirect := a * b
  direct := cp
  total := cp + (a * b)
"
```

## Model Fitting

We can now fit the model using the `sem()` function from `lavaan`.
We are using `missing = "fiml"` to handle missing data in `lavaan`.
Since there are missing values in `x`, we also set `fixed.x = FALSE`.


```r
fit <- sem(data = df, model = model, missing = "fiml", fixed.x = FALSE)
```

## Monte Carlo Confidence Intervals

The `fit` `lavaan` object can then be passed to the `MC()` function from `semmcci`
to generate Monte Carlo confidence intervals.


```r
MC(fit, R = 5000L, alpha = c(0.001, 0.01, 0.05))
#> Monte Carlo Confidence Intervals
#>              est     se    R   0.05%    0.5%    2.5%  97.5%  99.5% 99.95%
#> cp        0.2335 0.0296 5000  0.1417  0.1602  0.1756 0.2912 0.3089 0.3277
#> b         0.5112 0.0295 5000  0.4173  0.4385  0.4535 0.5682 0.5855 0.6059
#> a         0.4809 0.0288 5000  0.3884  0.4058  0.4246 0.5373 0.5534 0.5716
#> Y~~Y      0.5542 0.0269 5000  0.4669  0.4864  0.5012 0.6062 0.6211 0.6399
#> M~~M      0.7564 0.0368 5000  0.6308  0.6591  0.6845 0.8291 0.8476 0.8760
#> X~~X      1.0591 0.0498 5000  0.8872  0.9320  0.9625 1.1573 1.1857 1.2271
#> Y~1      -0.0127 0.0256 5000 -0.0958 -0.0793 -0.0628 0.0360 0.0557 0.0705
#> M~1      -0.0223 0.0289 5000 -0.1146 -0.0962 -0.0788 0.0335 0.0564 0.0775
#> X~1       0.0025 0.0334 5000 -0.1027 -0.0829 -0.0619 0.0673 0.0848 0.1049
#> indirect  0.2458 0.0206 5000  0.1775  0.1944  0.2062 0.2875 0.3035 0.3151
#> direct    0.2335 0.0296 5000  0.1417  0.1602  0.1756 0.2912 0.3089 0.3277
#> total     0.4794 0.0291 5000  0.3841  0.4022  0.4202 0.5350 0.5553 0.5688
```

## Nonparametric Bootstrap Confidence Intervals

Nonparametric bootstrap confidence intervals can be generated in `lavaan` using the following.


```r
parameterEstimates(
  sem(
    data = df,
    model = model,
    missing = "fiml",
    fixed.x = FALSE,
    se = "bootstrap",
    bootstrap = 5000L
  )
)
#>         lhs op      rhs    label    est    se      z pvalue ci.lower ci.upper
#> 1         Y  ~        X       cp  0.234 0.030  7.891  0.000    0.175    0.291
#> 2         Y  ~        M        b  0.511 0.031 16.657  0.000    0.450    0.572
#> 3         M  ~        X        a  0.481 0.029 16.755  0.000    0.426    0.538
#> 4         Y ~~        Y           0.554 0.027 20.256  0.000    0.499    0.606
#> 5         M ~~        M           0.756 0.036 20.731  0.000    0.685    0.829
#> 6         X ~~        X           1.059 0.052 20.559  0.000    0.963    1.163
#> 7         Y ~1                   -0.013 0.025 -0.507  0.612   -0.063    0.037
#> 8         M ~1                   -0.022 0.029 -0.772  0.440   -0.078    0.035
#> 9         X ~1                    0.002 0.034  0.074  0.941   -0.066    0.067
#> 10 indirect :=      a*b indirect  0.246 0.020 12.173  0.000    0.209    0.287
#> 11   direct :=       cp   direct  0.234 0.030  7.890  0.000    0.175    0.291
#> 12    total := cp+(a*b)    total  0.479 0.029 16.642  0.000    0.424    0.538
```

## Benchmark

### Arguments




|Variables |Values |Notes                               |
|:---------|:------|:-----------------------------------|
|R         |5000   |Number of Monte Carlo replications. |
|B         |5000   |Number of bootstrap samples.        |




```r
benchmark01 <- microbenchmark(
  MC = {
    fit <- sem(
      data = df,
      model = model,
      missing = "fiml",
      fixed.x = FALSE
    )
    MC(
      fit,
      R = R,
      pd = FALSE
    )
  },
  NB = sem(
    data = df,
    model = model,
    missing = "fiml",
    fixed.x = FALSE,
    se = "bootstrap",
    bootstrap = B
  ),
  times = 10
)
```

### Summary of Benchmark Results


```r
summary(benchmark01, unit = "ms")
#>   expr         min          lq        mean     median          uq         max
#> 1   MC    202.1584    221.3008    269.0019    232.211    252.6618    607.0082
#> 2   NB 120385.4318 121013.3895 125186.0946 125857.477 128113.0535 129753.2585
#>   neval
#> 1    10
#> 2    10
```

### Summary of Benchmark Results Relative to the Faster Method


```r
summary(benchmark01, unit = "relative")
#>   expr      min       lq     mean   median       uq      max neval
#> 1   MC   1.0000   1.0000   1.0000   1.0000   1.0000   1.0000    10
#> 2   NB 595.5006 546.8275 465.3726 541.9963 507.0534 213.7587    10
```

## Plot

![](fig-vignettes-benchmark-unnamed-chunk-17-1.png)

## Benchmark - Monte Carlo Method with Precalculated Estimates




```r
fit <- sem(
  data = df,
  model = model,
  missing = "fiml",
  fixed.x = FALSE
)
benchmark02 <- microbenchmark(
  MC = MC(
    fit,
    R = R, 
    pd = FALSE
  ),
  NB = sem(
    data = df,
    model = model,
    missing = "fiml",
    fixed.x = FALSE,
    se = "bootstrap",
    bootstrap = B
  ),
  times = 10
)
```

### Summary of Benchmark Results


```r
summary(benchmark02, unit = "ms")
#>   expr         min          lq        mean      median          uq        max
#> 1   MC    126.4147    128.3207    133.4782    130.2673    137.3684    157.549
#> 2   NB 117632.8445 121631.1537 126764.5958 124766.4845 130567.9636 139686.071
#>   neval
#> 1    10
#> 2    10
```

### Summary of Benchmark Results Relative to the Faster Method


```r
summary(benchmark02, unit = "relative")
#>   expr      min       lq     mean   median      uq    max neval
#> 1   MC   1.0000   1.0000   1.0000   1.0000   1.000   1.00    10
#> 2   NB 930.5315 947.8686 949.7024 957.7731 950.495 886.62    10
```

## Plot

![](fig-vignettes-benchmark-unnamed-chunk-22-1.png)
