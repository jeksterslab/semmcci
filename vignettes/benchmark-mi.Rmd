---
title: "Benchmark: Comparing the Monte Carlo Method with Nonparametric Bootstrapping (MI)"
author: "Ivan Jacob Agaloos Pesigan"
date: "2023-08-10"
bibliography: "vignettes.bib"
csl: https://raw.githubusercontent.com/citation-style-language/styles/master/apa.csl
nocite: |
  @Pesigan-Cheung-2023
output:
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{Benchmark: Comparing the Monte Carlo Method with Nonparametric Bootstrapping (MI)}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

<!-- vignettes/benchmark-mi.Rmd is generated from .setup/vignettes/benchmark-mi.Rmd.orig. Please edit that file -->







We compare the Monte Carlo (MC) method with nonparametric bootstrapping (NB) using the simple mediation model with missing data
using multiple imputation.
One advantage of MC over NB is speed.
This is because the model is only fitted once in MC whereas it is fitted many times in NB.


```r
library(semmcci)
library(lavaan)
library(Amelia)
library(microbenchmark)
```

## Data


```r
n <- 1000
a <- 0.50
b <- 0.50
cp <- 0.25
s2_em <- 1 - a^2
s2_ey <- 1 - cp^2 - a^2 * b^2 - b^2 * s2_em - 2 * cp * a * b
em <- rnorm(n = n, mean = 0, sd = sqrt(s2_em))
ey <- rnorm(n = n, mean = 0, sd = sqrt(s2_ey))
X <- rnorm(n = n)
M <- a * X + em
Y <- cp * X + b * M + ey
df <- data.frame(X, M, Y)

# Create data set with missing values.

miss <- sample(1:dim(df)[1], 300)
df[miss[1:100], "X"] <- NA
df[miss[101:200], "M"] <- NA
df[miss[201:300], "Y"] <- NA
```

## Multiple Imputation

Perform the appropriate multiple imputation approach to deal with missing values.
In this example, we impute multivariate missing data under the normal model.


```r
mi <- amelia(
  x = df,
  m = 5L,
  p2s = 0
)
```

## Model Specification

The indirect effect is defined by the product of the slopes
of paths `X` to `M` labeled as `a` and `M` to `Y` labeled as `b`.
In this example, we are interested in the confidence intervals of `indirect`
defined as the product of `a` and `b` using the `:=` operator
in the `lavaan` model syntax.


```r
model <- "
  Y ~ cp * X + b * M
  M ~ a * X
  X ~~ X
  indirect := a * b
  direct := cp
  total := cp + (a * b)
"
```

## Model Fitting

We can now fit the model using the `sem()` function from `lavaan`.
We do not need to deal with missing values in this stage.


```r
fit <- sem(data = df, model = model)
```

## Monte Carlo Confidence Intervals (Multiple Imputation)

The `fit` `lavaan` object and `mi` `mids` object can then be passed to the `MCMI()` function from `semmcci`
to generate Monte Carlo confidence intervals
using multiple imputation
as described in Pesigan and Cheung (2023).


```r
MCMI(fit, R = 100L, alpha = 0.05, mi = mi)
#> Monte Carlo Confidence Intervals (Multiple Imputation Estimates)
#>             est     se   R   2.5%  97.5%
#> cp       0.2274 0.0300 100 0.1794 0.2931
#> b        0.5192 0.0309 100 0.4506 0.5700
#> a        0.4790 0.0316 100 0.4129 0.5259
#> X~~X     1.0613 0.0531 100 0.9516 1.1674
#> Y~~Y     0.5439 0.0306 100 0.4847 0.5926
#> M~~M     0.7642 0.0417 100 0.6833 0.8485
#> indirect 0.2486 0.0197 100 0.2072 0.2855
#> direct   0.2274 0.0300 100 0.1794 0.2931
#> total    0.4760 0.0272 100 0.4276 0.5319
```

## Nonparametric Bootstrap Confidence Intervals (Multiple Imputation)

Nonparametric bootstrap confidence intervals can be generated in `bmemLavaan` using the following.



```r
summary(
  bmemLavaan::bmem(data = df, model = model, method = "mi", boot = 100L, m = 5L)
)
#> 
#> Estimate method:                          multiple imputation
#> Sample size:                              1000      
#> Number of request bootstrap draws:        100       
#> Number of successful bootstrap draws:     100       
#> Type of confidence interval:              perc
#> 
#> Values of statistics:
#> 
#>                      Value      SE      2.5%     97.5%
#>   chisq               0.000    0.000    0.000    0.000   
#>   GFI                 1.000    0.000    1.000    1.000   
#>   AGFI                1.000    0.000    1.000    1.000   
#>   RMSEA               0.000    0.000    0.000    0.000   
#>   NFI                 1.000    0.000    1.000    1.000   
#>   NNFI                1.000    0.000    1.000    1.000   
#>   CFI                 1.000    0.000    1.000    1.000   
#>   BIC                 7743.556 81.240   7580.008 7892.470
#>   SRMR                0.000    0.000    0.000    0.000   
#> 
#> Estimation of parameters:
#> 
#>                      Estimate   SE      2.5%     97.5%
#> Regressions:
#>   Y ~
#>     X        (cp)     0.233    0.030    0.172    0.294
#>     M         (b)     0.515    0.033    0.452    0.568
#>   M ~
#>     X         (a)     0.471    0.029    0.427    0.546
#> 
#> Variances:
#>     X                 1.060    0.047    0.974    1.158
#>     Y                 0.553    0.027    0.505    0.615
#>     M                 0.758    0.036    0.689    0.815
#> 
#> 
#> 
#> Defined parameters:
#>     a*b    (indr)     0.243    0.021    0.212    0.286
#>     cp     (drct)     0.233    0.030    0.172    0.294
#>     cp+(*) (totl)     0.476    0.026    0.430    0.525
```

## Benchmark

### Arguments





|Variables |Values |Notes                               |
|:---------|:------|:-----------------------------------|
|R         |100    |Number of Monte Carlo replications. |
|B         |100    |Number of bootstrap samples.        |
|m         |5      |Number of imputations.              |



## Benchmark




```r
benchmark_mi_01 <- microbenchmark(
  MC = {
    fit <- sem(
      data = df,
      model = model
    )
    mi <- Amelia::amelia(
      x = df,
      m = m,
      p2s = 0
    )
    MCMI(
      fit,
      R = R,
      decomposition = "chol",
      pd = FALSE,
      mi = mi
    )
  },
  NB = bmemLavaan::bmem(
    data = df,
    model = model,
    method = "mi",
    boot = B,
    m = m
  ),
  times = 10
)
```

### Summary of Benchmark Results


```r
summary(benchmark_mi_01, unit = "ms")
#>   expr        min         lq      mean     median         uq        max neval
#> 1   MC   317.1231   318.7643   329.505   328.5946   337.2843   348.0482    10
#> 2   NB 32127.9862 32355.3726 32588.880 32530.0621 32874.1932 33340.5005    10
```

### Summary of Benchmark Results Relative to the Faster Method


```r
summary(benchmark_mi_01, unit = "relative")
#>   expr      min       lq     mean   median       uq      max neval
#> 1   MC   1.0000   1.0000  1.00000  1.00000  1.00000  1.00000    10
#> 2   NB 101.3108 101.5025 98.90255 98.99756 97.46731 95.79277    10
```

## Plot

<img src="fig-vignettes-benchmark-unnamed-chunk-17-1.png" width="3300" />

## Benchmark - Monte Carlo Method with Precalculated Estimates and Multiple Imputation




```r
fit <- sem(
  data = df,
  model = model
)
mi <- Amelia::amelia(
  x = df,
  m = m,
  p2s = 0
)
benchmark_mi_02 <- microbenchmark(
  MC = MCMI(
    fit,
    R = R,
    decomposition = "chol",
    pd = FALSE,
    mi = mi
  ),
  NB = bmemLavaan::bmem(
    data = df,
    model = model,
    method = "mi",
    boot = B,
    m = m
  ),
  times = 10
)
```

### Summary of Benchmark Results


```r
summary(benchmark_mi_02, unit = "ms")
#>   expr        min         lq       mean     median         uq        max neval
#> 1   MC   211.2006   216.4222   224.6055   221.9282   225.6835   262.3087    10
#> 2   NB 32205.8410 32555.7322 32726.2929 32817.0628 32920.8268 33069.5342    10
```

### Summary of Benchmark Results Relative to the Faster Method


```r
summary(benchmark_mi_02, unit = "relative")
#>   expr      min      lq     mean   median       uq      max neval
#> 1   MC   1.0000   1.000   1.0000   1.0000   1.0000   1.0000    10
#> 2   NB 152.4893 150.427 145.7056 147.8724 145.8717 126.0711    10
```

## Plot

<img src="fig-vignettes-benchmark-unnamed-chunk-22-1.png" width="3300" />

## References
