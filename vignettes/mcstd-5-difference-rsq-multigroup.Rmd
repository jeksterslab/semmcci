---
title: "MCStd Function Use Case 5: Difference of R-Squared in Multiple Groups"
author: "Ivan Jacob Agaloos Pesigan"
date: "2023-07-21"
output:
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{MCStd Function Use Case 5: Difference of R-Squared in Multiple Groups}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

<!-- vignettes/mcstd-5-difference-rsq-multigroup.Rmd is generated from .setup/vignettes/mcstd-5-difference-rsq-multigroup.Rmd.orig. Please edit that file -->



To cite `semmcci` in publications, please use: 

Pesigan, I. J. A., & Cheung, S. F. (2023).
Monte Carlo confidence intervals for the indirect effect with missing data.
*Behavior Research Methods*.
https://doi.org/10.3758/s13428-023-02114-4



The `MCStd()` function is used
to generate Monte Carlo confidence intervals
for differences between $R^{2}$
in multiple groups.


```r
library(semmcci)
library(lavaan)
```

## Data

In this example,
we use data from Kwan and Chan (2014)
with three groups (Hong Kong, Japan, and Korea)
where child's reading ability ($Y_{1}$)
is regressed on
parental occupational status ($X_{1}$),
parental educational level ($X_{2}$), and
child's home possession ($X_{3}$)

\begin{equation}
    Y_{1}
    =
    \alpha_{1}
    +
    \gamma_{1}
    X_{1}
    +
    \gamma_{2}
    X_{2}
    +
    \gamma_{3}
    X_{3}
    +
    \zeta_{1} .
\end{equation}

\noindent Note that $\zeta_{1}$ is the stochastic error term
with expected value of zero
and finite variance $\psi_{1}$,
$\alpha_{1}$ is the intercept,
and $\gamma_{1}$, $\gamma_{2}$, and $\gamma_{3}$
are regression coefficients.

![A Three-Regressor Multiple Regression Model (Covariance Structure)](https://raw.githubusercontent.com/jeksterslab/semmcci/main/latexsrc/figures/png/kwan-2011-example-1.png)




```r
knitr::kable(
  x = covs_hongkong, digits = 4,
  caption = "Covariance Matrix for Hong Kong"
)
```



Table: Covariance Matrix for Hong Kong

|   |        Y1|      X1|      X2|      X3|
|:--|---------:|-------:|-------:|-------:|
|Y1 | 8176.0021| 27.3990| 28.2320| 31.2722|
|X1 |   27.3990|  0.9451|  0.6006|  0.4326|
|X2 |   28.2320|  0.6006|  0.7977|  0.3779|
|X3 |   31.2722|  0.4326|  0.3779|  0.8956|



```r
nobs_hongkong
#> [1] 4625
```




```r
knitr::kable(
  x = covs_japan, digits = 4,
  caption = "Covariance Matrix for Japan"
)
```



Table: Covariance Matrix for Japan

|   |        Y1|      X1|      X2|      X3|
|:--|---------:|-------:|-------:|-------:|
|Y1 | 9666.8658| 34.2501| 35.2189| 30.6472|
|X1 |   34.2501|  1.0453|  0.6926|  0.5027|
|X2 |   35.2189|  0.6926|  1.0777|  0.4524|
|X3 |   30.6472|  0.5027|  0.4524|  0.9583|



```r
nobs_japan
#> [1] 5943
```


```r
nobs_korea <- 5151
covs_korea <- matrix(
  data = c(
    8187.6921, 31.6266, 37.3062, 30.9021,
    31.6266, 0.9271, 0.6338, 0.4088,
    37.3062, 0.6338, 1.0007, 0.3902,
    30.9021, 0.4088, 0.3902, 0.8031
  ),
  nrow = 4
)
colnames(covs_korea) <- rownames(covs_korea) <- varnames
knitr::kable(
  x = covs_korea, digits = 4,
  caption = "Covariance Matrix for Korea"
)
```



Table: Covariance Matrix for Korea

|   |        Y1|      X1|      X2|      X3|
|:--|---------:|-------:|-------:|-------:|
|Y1 | 8187.6921| 31.6266| 37.3062| 30.9021|
|X1 |   31.6266|  0.9271|  0.6338|  0.4088|
|X2 |   37.3062|  0.6338|  1.0007|  0.3902|
|X3 |   30.9021|  0.4088|  0.3902|  0.8031|



## Model Specification

We regress `Y1` on `X1`, `X2`, and `X3`.
We label the error variance
$\zeta_{1}$
for the three groups as
`psi1.g1`, `psi1.g2`, and `psi1.g3`.
$R^{2}$
is defined using the `:=` operator
in the `lavaan` model syntax
using the following equation

\begin{equation}
    R^{2}
    =
    1 - \psi^{\ast}
\end{equation}

\noindent where $\psi^{\ast}$
is the standardized error variance.


```r
model <- "
  Y1 ~ X1 + X2 + X3
  Y1 ~~ c(psi1.g1, psi1.g2, psi1.g3) * Y1
  rsq.g1 := 1 - psi1.g1
  rsq.g2 := 1 - psi1.g2
  rsq.g3 := 1 - psi1.g3
  rsq.g12 := rsq.g1 - rsq.g2
  rsq.g13 := rsq.g1 - rsq.g3
  rsq.g23 := rsq.g2 - rsq.g3
"
```

## Model Fitting

We can now fit the model using the `sem()` function from `lavaan`
with `mimic = "eqs"`
to ensure compatibility with results from Kwan and Chan (2011).

> **Note:** We recommend setting `fixed.x = FALSE`
> when generating standardized estimates and confidence intervals
> to model the variances and covariances of the exogenous observed variables
> if they are assumed to be random.
> If `fixed.x = TRUE`, which is the default setting in `lavaan`,
> `MC()` will fix the variances and the covariances
> of the exogenous observed variables to the sample values.


```r
fit <- sem(
  model = model, mimic = "eqs", fixed.x = FALSE,
  sample.cov = list(covs_hongkong, covs_japan, covs_korea),
  sample.nobs = list(nobs_hongkong, nobs_japan, nobs_korea)
)
```

## Standardized Monte Carlo Confidence Intervals

Standardized Monte Carlo Confidence intervals can be generated by passing the result of the `MC()` function to the `MCStd()` function.

> **Note:** The parameterization of $R^{2}$ and above
> should only be interpreted using the output of the `MCStd()` function
> since the input in the functions defined by `:=`
> require standardized estimates.


```r
unstd <- MC(fit, R = 20000L, alpha = 0.05)
MCStd(unstd, alpha = 0.05)
#> Standardized Monte Carlo Confidence Intervals
#>               est     se     R    2.5%   97.5%
#> Y1~X1      0.0568 0.0191 20000  0.0199  0.0945
#> Y1~X2      0.1985 0.0186 20000  0.1619  0.2349
#> Y1~X3      0.2500 0.0151 20000  0.2196  0.2792
#> psi1.g1    0.8215 0.0102 20000  0.8009  0.8409
#> X1~~X1     1.0000 0.0000 20000  1.0000  1.0000
#> X1~~X2     0.6917 0.0076 20000  0.6765  0.7065
#> X1~~X3     0.4702 0.0115 20000  0.4473  0.4925
#> X2~~X2     1.0000 0.0000 20000  1.0000  1.0000
#> X2~~X3     0.4471 0.0118 20000  0.4236  0.4700
#> X3~~X3     1.0000 0.0000 20000  1.0000  1.0000
#> Y1~X1.g2   0.1390 0.0164 20000  0.1067  0.1711
#> Y1~X2.g2   0.1792 0.0158 20000  0.1481  0.2101
#> Y1~X3.g2   0.1688 0.0139 20000  0.1418  0.1959
#> psi1.g2    0.8371 0.0088 20000  0.8191  0.8538
#> X1~~X1.g2  1.0000 0.0000 20000  1.0000  1.0000
#> X1~~X2.g2  0.6525 0.0074 20000  0.6379  0.6671
#> X1~~X3.g2  0.5023 0.0098 20000  0.4828  0.5213
#> X2~~X2.g2  1.0000 0.0000 20000  1.0000  1.0000
#> X2~~X3.g2  0.4452 0.0103 20000  0.4247  0.4654
#> X3~~X3.g2  1.0000 0.0000 20000  1.0000  1.0000
#> Y1~X1.g3   0.0863 0.0171 20000  0.0528  0.1198
#> Y1~X2.g3   0.2557 0.0163 20000  0.2241  0.2877
#> Y1~X3.g3   0.2289 0.0139 20000  0.2014  0.2560
#> psi1.g3    0.7761 0.0102 20000  0.7555  0.7958
#> X1~~X1.g3  1.0000 0.0000 20000  1.0000  1.0000
#> X1~~X2.g3  0.6580 0.0079 20000  0.6422  0.6733
#> X1~~X3.g3  0.4738 0.0108 20000  0.4521  0.4947
#> X2~~X2.g3  1.0000 0.0000 20000  1.0000  1.0000
#> X2~~X3.g3  0.4353 0.0113 20000  0.4128  0.4573
#> X3~~X3.g3  1.0000 0.0000 20000  1.0000  1.0000
#> rsq.g1     0.1785 0.0102 20000  0.1591  0.1991
#> rsq.g2     0.1629 0.0088 20000  0.1462  0.1809
#> rsq.g3     0.2239 0.0102 20000  0.2042  0.2445
#> rsq.g12    0.0155 0.0135 20000 -0.0110  0.0421
#> rsq.g13   -0.0455 0.0144 20000 -0.0735 -0.0172
#> rsq.g23   -0.0610 0.0136 20000 -0.0877 -0.0343
```

## References

Kwan, J. L. Y., & Chan, W. (2014).
Comparing squared multiple correlation coefficients using structural equation modeling
*Structural Equation Modeling: A Multidisciplinary Journal*, *21*(2), 225-238.
https://doi.org/10.1080/10705511.2014.882673
