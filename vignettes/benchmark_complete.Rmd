---
title: "Benchmark: Comparing the Monte Carlo Method with Nonparametric Bootstrapping"
author: "Ivan Jacob Agaloos Pesigan"
date: "2023-05-16"
output:
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{Benchmark: Comparing the Monte Carlo Method with Nonparametric Bootstrapping}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---







We compare the Monte Carlo (MC) method with nonparametric bootstrapping (NB) using the simple mediation model with complete data.
One advantage of MC over NB is speed.
This is because the model is only fitted once in MC whereas it is fitted many times in NB.


```r
library(semmcci)
library(lavaan)
library(microbenchmark)
```

## Data


```r
n <- 1000
a <- 0.50
b <- 0.50
cp <- 0.25
s2_em <- 1 - a^2
s2_ey <- 1 - cp^2 - a^2 * b^2 - b^2 * s2_em - 2 * cp * a * b
em <- rnorm(n = n, mean = 0, sd = sqrt(s2_em))
ey <- rnorm(n = n, mean = 0, sd = sqrt(s2_ey))
X <- rnorm(n = n)
M <- a * X + em
Y <- cp * X + b * M + ey
df <- data.frame(X, M, Y)
```

## Model Specification

The indirect effect is defined by the product of the slopes
of paths `X` to `M` labeled as `a` and `M` to `Y` labeled as `b`.
In this example, we are interested in the confidence intervals of `indirect`
defined as the product of `a` and `b` using the `:=` operator
in the `lavaan` model syntax.


```r
model <- "
  Y ~ cp * X + b * M
  M ~ a * X
  X ~~ X
  indirect := a * b
  direct := cp
  total := cp + (a * b)
"
```

## Model Fitting

We can now fit the model using the `sem()` function from `lavaan`.


```r
fit <- sem(data = df, model = model)
```

## Monte Carlo Confidence Intervals

The `fit` `lavaan` object can then be passed to the `MC()` function from `semmcci`
to generate Monte Carlo confidence intervals.


```r
MC(fit, R = 100L, alpha = 0.05)
#> Monte Carlo Confidence Intervals
#>             est     se   R   2.5%  97.5%
#> cp       0.2333 0.0268 100 0.1782 0.2759
#> b        0.5082 0.0276 100 0.4480 0.5560
#> a        0.4820 0.0289 100 0.4233 0.5269
#> X~~X     1.0590 0.0560 100 0.9417 1.1674
#> Y~~Y     0.5462 0.0242 100 0.4999 0.5972
#> M~~M     0.7527 0.0338 100 0.6863 0.8118
#> indirect 0.2449 0.0186 100 0.2048 0.2804
#> direct   0.2333 0.0268 100 0.1782 0.2759
#> total    0.4782 0.0271 100 0.4217 0.5246
```

## Nonparametric Bootstrap Confidence Intervals

Nonparametric bootstrap confidence intervals can be generated in `lavaan` using the following.


```r
parameterEstimates(
  sem(
    data = df,
    model = model,
    se = "bootstrap",
    bootstrap = 100L
  )
)
#>        lhs op      rhs    label   est    se      z pvalue ci.lower ci.upper
#> 1        Y  ~        X       cp 0.233 0.028  8.422      0    0.178    0.289
#> 2        Y  ~        M        b 0.508 0.028 18.338      0    0.457    0.572
#> 3        M  ~        X        a 0.482 0.024 20.493      0    0.421    0.536
#> 4        X ~~        X          1.059 0.050 21.272      0    0.960    1.198
#> 5        Y ~~        Y          0.546 0.026 20.763      0    0.488    0.601
#> 6        M ~~        M          0.753 0.032 23.839      0    0.683    0.809
#> 7 indirect :=      a*b indirect 0.245 0.018 13.382      0    0.215    0.285
#> 8   direct :=       cp   direct 0.233 0.028  8.380      0    0.178    0.289
#> 9    total := cp+(a*b)    total 0.478 0.027 17.623      0    0.428    0.538
```

## Benchmark

### Arguments




|Variables |Values |Notes                               |
|:---------|:------|:-----------------------------------|
|R         |1000   |Number of Monte Carlo replications. |
|B         |1000   |Number of bootstrap samples.        |




```r
benchmark_complete_01 <- microbenchmark(
  MC = {
    fit <- sem(
      data = df,
      model = model
    )
    MC(
      fit,
      R = R,
      decomposition = "chol",
      pd = FALSE
    )
  },
  NB = sem(
    data = df,
    model = model,
    se = "bootstrap",
    bootstrap = B
  ),
  times = 10
)
```

### Summary of Benchmark Results


```r
summary(benchmark_complete_01, unit = "ms")
#>   expr        min          lq        mean      median          uq        max
#> 1   MC    81.7416    85.26495    89.47987    87.38037    94.77134   100.2696
#> 2   NB 15011.1406 15067.82272 15173.24353 15180.97662 15242.55330 15372.0392
#>   neval
#> 1    10
#> 2    10
```

### Summary of Benchmark Results Relative to the Faster Method


```r
summary(benchmark_complete_01, unit = "relative")
#>   expr      min       lq     mean   median      uq     max neval
#> 1   MC   1.0000   1.0000   1.0000   1.0000   1.000   1.000    10
#> 2   NB 183.6414 176.7177 169.5716 173.7344 160.835 153.307    10
```

## Plot

<img src="fig-vignettes-benchmark-unnamed-chunk-16-1.png" width="3300" />

## Benchmark - Monte Carlo Method with Precalculated Estimates




```r
fit <- sem(
  data = df,
  model = model
)
benchmark_complete_02 <- microbenchmark(
  MC = MC(
    fit,
    R = R,
    decomposition = "chol",
    pd = FALSE
  ),
  NB = sem(
    data = df,
    model = model,
    se = "bootstrap",
    bootstrap = B
  ),
  times = 10
)
```

### Summary of Benchmark Results


```r
summary(benchmark_complete_02, unit = "ms")
#>   expr         min          lq        mean      median          uq         max
#> 1   MC    20.62233    22.14931    25.75062    23.48991    30.03411    33.01449
#> 2   NB 14947.93925 15031.86212 15075.67285 15084.42550 15123.37727 15209.17606
#>   neval
#> 1    10
#> 2    10
```

### Summary of Benchmark Results Relative to the Faster Method


```r
summary(benchmark_complete_02, unit = "relative")
#>   expr      min       lq    mean   median     uq      max neval
#> 1   MC   1.0000   1.0000   1.000   1.0000   1.00   1.0000    10
#> 2   NB 724.8423 678.6604 585.449 642.1662 503.54 460.6818    10
```

## Plot

<img src="fig-vignettes-benchmark-unnamed-chunk-21-1.png" width="3300" />
