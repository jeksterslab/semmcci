---
title: "Benchmark: Comparing the Monte Carlo Method with Nonparametric Bootstrapping"
author: "Ivan Jacob Agaloos Pesigan"
date: "2023-06-02"
output:
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{Benchmark: Comparing the Monte Carlo Method with Nonparametric Bootstrapping}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---







We compare the Monte Carlo (MC) method with nonparametric bootstrapping (NB) using the simple mediation model with complete data.
One advantage of MC over NB is speed.
This is because the model is only fitted once in MC whereas it is fitted many times in NB.


```r
library(semmcci)
library(lavaan)
library(microbenchmark)
```

## Data


```r
n <- 1000
a <- 0.50
b <- 0.50
cp <- 0.25
s2_em <- 1 - a^2
s2_ey <- 1 - cp^2 - a^2 * b^2 - b^2 * s2_em - 2 * cp * a * b
em <- rnorm(n = n, mean = 0, sd = sqrt(s2_em))
ey <- rnorm(n = n, mean = 0, sd = sqrt(s2_ey))
X <- rnorm(n = n)
M <- a * X + em
Y <- cp * X + b * M + ey
df <- data.frame(X, M, Y)
```

## Model Specification

The indirect effect is defined by the product of the slopes
of paths `X` to `M` labeled as `a` and `M` to `Y` labeled as `b`.
In this example, we are interested in the confidence intervals of `indirect`
defined as the product of `a` and `b` using the `:=` operator
in the `lavaan` model syntax.


```r
model <- "
  Y ~ cp * X + b * M
  M ~ a * X
  X ~~ X
  indirect := a * b
  direct := cp
  total := cp + (a * b)
"
```

## Model Fitting

We can now fit the model using the `sem()` function from `lavaan`.


```r
fit <- sem(data = df, model = model)
```

## Monte Carlo Confidence Intervals

The `fit` `lavaan` object can then be passed to the `MC()` function from `semmcci`
to generate Monte Carlo confidence intervals.


```r
MC(fit, R = 100L, alpha = 0.05)
#> Monte Carlo Confidence Intervals
#>             est     se   R   2.5%  97.5%
#> cp       0.2333 0.0243 100 0.1877 0.2816
#> b        0.5082 0.0270 100 0.4584 0.5639
#> a        0.4820 0.0288 100 0.4248 0.5369
#> X~~X     1.0590 0.0440 100 0.9731 1.1385
#> Y~~Y     0.5462 0.0255 100 0.4883 0.5831
#> M~~M     0.7527 0.0341 100 0.6892 0.8166
#> indirect 0.2449 0.0192 100 0.2135 0.2807
#> direct   0.2333 0.0243 100 0.1877 0.2816
#> total    0.4782 0.0289 100 0.4306 0.5426
```

## Nonparametric Bootstrap Confidence Intervals

Nonparametric bootstrap confidence intervals can be generated in `lavaan` using the following.


```r
parameterEstimates(
  sem(
    data = df,
    model = model,
    se = "bootstrap",
    bootstrap = 100L
  )
)
#>        lhs op      rhs    label   est    se      z pvalue ci.lower ci.upper
#> 1        Y  ~        X       cp 0.233 0.024  9.605      0    0.183    0.275
#> 2        Y  ~        M        b 0.508 0.025 20.086      0    0.442    0.554
#> 3        M  ~        X        a 0.482 0.028 17.521      0    0.419    0.535
#> 4        X ~~        X          1.059 0.045 23.603      0    0.985    1.154
#> 5        Y ~~        Y          0.546 0.024 23.154      0    0.504    0.597
#> 6        M ~~        M          0.753 0.035 21.592      0    0.689    0.856
#> 7 indirect :=      a*b indirect 0.245 0.018 13.336      0    0.207    0.278
#> 8   direct :=       cp   direct 0.233 0.024  9.556      0    0.183    0.275
#> 9    total := cp+(a*b)    total 0.478 0.030 15.910      0    0.424    0.532
```

## Benchmark

### Arguments





|Variables |Values |Notes                               |
|:---------|:------|:-----------------------------------|
|R         |1000   |Number of Monte Carlo replications. |
|B         |1000   |Number of bootstrap samples.        |






```r
benchmark_complete_01 <- microbenchmark(
  MC = {
    fit <- sem(
      data = df,
      model = model
    )
    MC(
      fit,
      R = R,
      decomposition = "chol",
      pd = FALSE
    )
  },
  NB = sem(
    data = df,
    model = model,
    se = "bootstrap",
    bootstrap = B
  ),
  times = 10
)
```

### Summary of Benchmark Results


```r
summary(benchmark_complete_01, unit = "ms")
#>   expr         min          lq        mean      median          uq        max
#> 1   MC    82.06245    82.60348    87.95024    86.48915    91.15124   101.8874
#> 2   NB 14307.78281 14361.87012 14515.04477 14542.46399 14629.29084 14734.3331
#>   neval
#> 1    10
#> 2    10
```

### Summary of Benchmark Results Relative to the Faster Method


```r
summary(benchmark_complete_01, unit = "relative")
#>   expr      min       lq    mean   median       uq      max neval
#> 1   MC   1.0000   1.0000   1.000   1.0000   1.0000   1.0000    10
#> 2   NB 174.3524 173.8652 165.037 168.1421 160.4947 144.6139    10
```

## Plot

<img src="fig-vignettes-benchmark-unnamed-chunk-16-1.png" width="3300" />

## Benchmark - Monte Carlo Method with Precalculated Estimates




```r
fit <- sem(
  data = df,
  model = model
)
benchmark_complete_02 <- microbenchmark(
  MC = MC(
    fit,
    R = R,
    decomposition = "chol",
    pd = FALSE
  ),
  NB = sem(
    data = df,
    model = model,
    se = "bootstrap",
    bootstrap = B
  ),
  times = 10
)
```

### Summary of Benchmark Results


```r
summary(benchmark_complete_02, unit = "ms")
#>   expr         min          lq        mean      median          uq         max
#> 1   MC    17.31807    22.57695    24.75557    24.91911    27.97839    28.53754
#> 2   NB 14214.18844 14349.72874 14496.25847 14436.42065 14667.06037 14822.97099
#>   neval
#> 1    10
#> 2    10
```

### Summary of Benchmark Results Relative to the Faster Method


```r
summary(benchmark_complete_02, unit = "relative")
#>   expr     min       lq     mean   median       uq      max neval
#> 1   MC   1.000   1.0000   1.0000   1.0000   1.0000   1.0000    10
#> 2   NB 820.772 635.5921 585.5757 579.3314 524.2281 519.4201    10
```

## Plot

<img src="fig-vignettes-benchmark-unnamed-chunk-21-1.png" width="3300" />
