---
title: "Benchmark: Comparing the Monte Carlo Method with Nonparametric Bootstrapping"
author: "Ivan Jacob Agaloos Pesigan"
date: "2023-05-07"
output:
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{Benchmark: Comparing the Monte Carlo Method with Nonparametric Bootstrapping}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---







We compare the Monte Carlo (MC) method with nonparametric bootstrapping (NB) using the simple mediation model with complete data.
One advantage of MC over NB is speed.
This is because the model is only fitted once in MC whereas it is fitted many times in NB.


```r
library(semmcci)
library(lavaan)
library(microbenchmark)
```

## Data


```r
n <- 1000
a <- 0.50
b <- 0.50
cp <- 0.25
s2_em <- 1 - a^2
s2_ey <- 1 - cp^2 - a^2 * b^2 - b^2 * s2_em - 2 * cp * a * b
em <- rnorm(n = n, mean = 0, sd = sqrt(s2_em))
ey <- rnorm(n = n, mean = 0, sd = sqrt(s2_ey))
X <- rnorm(n = n)
M <- a * X + em
Y <- cp * X + b * M + ey
df <- data.frame(X, M, Y)
```

## Model Specification

The indirect effect is defined by the product of the slopes
of paths `X` to `M` labeled as `a` and `M` to `Y` labeled as `b`.
In this example, we are interested in the confidence intervals of `indirect`
defined as the product of `a` and `b` using the `:=` operator
in the `lavaan` model syntax.


```r
model <- "
  Y ~ cp * X + b * M
  M ~ a * X
  X ~~ X
  indirect := a * b
  direct := cp
  total := cp + (a * b)
"
```

## Model Fitting

We can now fit the model using the `sem()` function from `lavaan`.


```r
fit <- sem(data = df, model = model)
```

## Monte Carlo Confidence Intervals

The `fit` `lavaan` object can then be passed to the `MC()` function from `semmcci`
to generate Monte Carlo confidence intervals.


```r
MC(fit, R = 100L, alpha = 0.05)
#> Monte Carlo Confidence Intervals
#>             est     se   R   2.5%  97.5%
#> cp       0.2333 0.0285 100 0.1786 0.2846
#> b        0.5082 0.0295 100 0.4597 0.5623
#> a        0.4820 0.0271 100 0.4336 0.5349
#> X~~X     1.0590 0.0490 100 0.9594 1.1445
#> Y~~Y     0.5462 0.0253 100 0.4960 0.5926
#> M~~M     0.7527 0.0366 100 0.6901 0.8143
#> indirect 0.2449 0.0184 100 0.2108 0.2807
#> direct   0.2333 0.0285 100 0.1786 0.2846
#> total    0.4782 0.0258 100 0.4315 0.5253
```

## Nonparametric Bootstrap Confidence Intervals

Nonparametric bootstrap confidence intervals can be generated in `lavaan` using the following.


```r
parameterEstimates(
  sem(
    data = df,
    model = model,
    se = "bootstrap",
    bootstrap = 100L
  )
)
#>        lhs op      rhs    label   est    se      z pvalue ci.lower ci.upper
#> 1        Y  ~        X       cp 0.233 0.032  7.237      0    0.176    0.309
#> 2        Y  ~        M        b 0.508 0.028 17.982      0    0.457    0.564
#> 3        M  ~        X        a 0.482 0.026 18.547      0    0.418    0.539
#> 4        X ~~        X          1.059 0.046 23.156      0    0.968    1.138
#> 5        Y ~~        Y          0.546 0.025 21.902      0    0.505    0.595
#> 6        M ~~        M          0.753 0.032 23.172      0    0.676    0.819
#> 7 indirect :=      a*b indirect 0.245 0.019 13.036      0    0.210    0.283
#> 8   direct :=       cp   direct 0.233 0.032  7.201      0    0.176    0.309
#> 9    total := cp+(a*b)    total 0.478 0.030 16.078      0    0.430    0.551
```

## Benchmark

### Arguments




|Variables |Values |Notes                               |
|:---------|:------|:-----------------------------------|
|R         |1000   |Number of Monte Carlo replications. |
|B         |1000   |Number of bootstrap samples.        |




```r
benchmark_complete_01 <- microbenchmark(
  MC = {
    fit <- sem(
      data = df,
      model = model
    )
    MC(
      fit,
      R = R,
      decomposition = "chol",
      pd = FALSE
    )
  },
  NB = sem(
    data = df,
    model = model,
    se = "bootstrap",
    bootstrap = B
  ),
  times = 10
)
```

### Summary of Benchmark Results


```r
summary(benchmark_complete_01, unit = "ms")
#>   expr         min         lq        mean      median          uq         max
#> 1   MC    58.33408    60.8456    69.64924    69.72595    79.02144    81.39875
#> 2   NB 10862.73243 10907.2889 10982.83683 10943.08591 10981.32484 11294.70704
#>   neval
#> 1    10
#> 2    10
```

### Summary of Benchmark Results Relative to the Faster Method


```r
summary(benchmark_complete_01, unit = "relative")
#>   expr      min       lq     mean   median       uq      max neval
#> 1   MC   1.0000   1.0000   1.0000   1.0000   1.0000   1.0000    10
#> 2   NB 186.2159 179.2618 157.6878 156.9442 138.9664 138.7577    10
```

## Plot

<img src="fig-vignettes-benchmark-unnamed-chunk-16-1.png" width="3300" />

## Benchmark - Monte Carlo Method with Precalculated Estimates




```r
fit <- sem(
  data = df,
  model = model
)
benchmark_complete_02 <- microbenchmark(
  MC = MC(
    fit,
    R = R,
    decomposition = "chol",
    pd = FALSE
  ),
  NB = sem(
    data = df,
    model = model,
    se = "bootstrap",
    bootstrap = B
  ),
  times = 10
)
```

### Summary of Benchmark Results


```r
summary(benchmark_complete_02, unit = "ms")
#>   expr         min          lq        mean      median         uq         max
#> 1   MC    16.37104    16.55182    18.18613    17.31626    19.7871    21.38382
#> 2   NB 10808.77233 10854.65885 10889.52635 10879.42196 10936.3400 10993.36155
#>   neval
#> 1    10
#> 2    10
```

### Summary of Benchmark Results Relative to the Faster Method


```r
summary(benchmark_complete_02, unit = "relative")
#>   expr      min       lq    mean   median       uq      max neval
#> 1   MC   1.0000   1.0000   1.000   1.0000   1.0000   1.0000    10
#> 2   NB 660.2373 655.7987 598.782 628.2778 552.7004 514.0972    10
```

## Plot

<img src="fig-vignettes-benchmark-unnamed-chunk-21-1.png" width="3300" />
