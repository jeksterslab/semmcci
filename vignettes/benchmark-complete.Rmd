---
title: "Benchmark: Comparing the Monte Carlo Method with Nonparametric Bootstrapping"
author: "Ivan Jacob Agaloos Pesigan"
date: "2023-07-21"
bibliography: "vignettes.bib"
csl: https://raw.githubusercontent.com/citation-style-language/styles/master/apa.csl
nocite: |
  @Pesigan-Cheung-2023
output:
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{Benchmark: Comparing the Monte Carlo Method with Nonparametric Bootstrapping}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

<!-- vignettes/benchmark-complete.Rmd is generated from .setup/vignettes/benchmark-complete.Rmd.orig. Please edit that file -->







We compare the Monte Carlo (MC) method with nonparametric bootstrapping (NB) using the simple mediation model with complete data.
One advantage of MC over NB is speed.
This is because the model is only fitted once in MC whereas it is fitted many times in NB.


```r
library(semmcci)
library(lavaan)
library(microbenchmark)
```

## Data


```r
n <- 1000
a <- 0.50
b <- 0.50
cp <- 0.25
s2_em <- 1 - a^2
s2_ey <- 1 - cp^2 - a^2 * b^2 - b^2 * s2_em - 2 * cp * a * b
em <- rnorm(n = n, mean = 0, sd = sqrt(s2_em))
ey <- rnorm(n = n, mean = 0, sd = sqrt(s2_ey))
X <- rnorm(n = n)
M <- a * X + em
Y <- cp * X + b * M + ey
df <- data.frame(X, M, Y)
```

## Model Specification

The indirect effect is defined by the product of the slopes
of paths `X` to `M` labeled as `a` and `M` to `Y` labeled as `b`.
In this example, we are interested in the confidence intervals of `indirect`
defined as the product of `a` and `b` using the `:=` operator
in the `lavaan` model syntax.


```r
model <- "
  Y ~ cp * X + b * M
  M ~ a * X
  X ~~ X
  indirect := a * b
  direct := cp
  total := cp + (a * b)
"
```

## Model Fitting

We can now fit the model using the `sem()` function from `lavaan`.


```r
fit <- sem(data = df, model = model)
```

## Monte Carlo Confidence Intervals

The `fit` `lavaan` object can then be passed to the `MC()` function from `semmcci`
to generate Monte Carlo confidence intervals.


```r
MC(fit, R = 100L, alpha = 0.05)
#> Monte Carlo Confidence Intervals
#>             est     se   R   2.5%  97.5%
#> cp       0.2333 0.0253 100 0.1887 0.2831
#> b        0.5082 0.0244 100 0.4668 0.5567
#> a        0.4820 0.0267 100 0.4307 0.5352
#> X~~X     1.0590 0.0504 100 0.9608 1.1551
#> Y~~Y     0.5462 0.0259 100 0.5057 0.6010
#> M~~M     0.7527 0.0326 100 0.6919 0.8101
#> indirect 0.2449 0.0170 100 0.2168 0.2870
#> direct   0.2333 0.0253 100 0.1887 0.2831
#> total    0.4782 0.0277 100 0.4405 0.5298
```

## Nonparametric Bootstrap Confidence Intervals

Nonparametric bootstrap confidence intervals can be generated in `lavaan` using the following.


```r
parameterEstimates(
  sem(
    data = df,
    model = model,
    se = "bootstrap",
    bootstrap = 100L
  )
)
#>        lhs op      rhs    label   est    se      z pvalue ci.lower ci.upper
#> 1        Y  ~        X       cp 0.233 0.025  9.240      0    0.182    0.283
#> 2        Y  ~        M        b 0.508 0.027 18.986      0    0.448    0.563
#> 3        M  ~        X        a 0.482 0.027 17.787      0    0.428    0.534
#> 4        X ~~        X          1.059 0.050 21.262      0    0.961    1.175
#> 5        Y ~~        Y          0.546 0.024 22.927      0    0.500    0.588
#> 6        M ~~        M          0.753 0.031 23.955      0    0.685    0.815
#> 7 indirect :=      a*b indirect 0.245 0.020 12.089      0    0.207    0.292
#> 8   direct :=       cp   direct 0.233 0.025  9.194      0    0.182    0.283
#> 9    total := cp+(a*b)    total 0.478 0.027 17.942      0    0.427    0.531
```

## Benchmark

### Arguments





|Variables |Values |Notes                               |
|:---------|:------|:-----------------------------------|
|R         |1000   |Number of Monte Carlo replications. |
|B         |1000   |Number of bootstrap samples.        |






```r
benchmark_complete_01 <- microbenchmark(
  MC = {
    fit <- sem(
      data = df,
      model = model
    )
    MC(
      fit,
      R = R,
      decomposition = "chol",
      pd = FALSE
    )
  },
  NB = sem(
    data = df,
    model = model,
    se = "bootstrap",
    bootstrap = B
  ),
  times = 10
)
```

### Summary of Benchmark Results


```r
summary(benchmark_complete_01, unit = "ms")
#>   expr        min         lq       mean     median         uq       max neval
#> 1   MC   121.7938   123.1392   129.3429   128.7376   133.3385   142.269    10
#> 2   NB 25113.1355 25454.9805 25717.3693 25686.8568 25951.3230 26290.795    10
```

### Summary of Benchmark Results Relative to the Faster Method


```r
summary(benchmark_complete_01, unit = "relative")
#>   expr      min       lq     mean   median       uq      max neval
#> 1   MC   1.0000   1.0000   1.0000   1.0000   1.0000   1.0000    10
#> 2   NB 206.1939 206.7171 198.8309 199.5288 194.6274 184.7964    10
```

## Plot

<img src="fig-vignettes-benchmark-unnamed-chunk-16-1.png" width="3300" />

## Benchmark - Monte Carlo Method with Precalculated Estimates




```r
fit <- sem(
  data = df,
  model = model
)
benchmark_complete_02 <- microbenchmark(
  MC = MC(
    fit,
    R = R,
    decomposition = "chol",
    pd = FALSE
  ),
  NB = sem(
    data = df,
    model = model,
    se = "bootstrap",
    bootstrap = B
  ),
  times = 10
)
```

### Summary of Benchmark Results


```r
summary(benchmark_complete_02, unit = "ms")
#>   expr        min         lq        mean     median       uq        max neval
#> 1   MC    17.0099    25.6254    34.99858    38.0975    43.14    49.4224    10
#> 2   NB 25054.7084 25199.8844 25574.50759 25446.0585 25978.55 26327.9333    10
```

### Summary of Benchmark Results Relative to the Faster Method


```r
summary(benchmark_complete_02, unit = "relative")
#>   expr      min       lq     mean   median       uq      max neval
#> 1   MC    1.000   1.0000   1.0000   1.0000   1.0000   1.0000    10
#> 2   NB 1472.949 983.3948 730.7299 667.9194 602.1916 532.7126    10
```

## Plot

<img src="fig-vignettes-benchmark-unnamed-chunk-21-1.png" width="3300" />

## References
