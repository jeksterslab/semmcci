---
title: "Benchmark: Comparing the Monte Carlo Method with Nonparametric Bootstrapping"
author: "Ivan Jacob Agaloos Pesigan"
date: "2023-08-10"
bibliography: "vignettes.bib"
csl: https://raw.githubusercontent.com/citation-style-language/styles/master/apa.csl
nocite: |
  @Pesigan-Cheung-2023
output:
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{Benchmark: Comparing the Monte Carlo Method with Nonparametric Bootstrapping}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

<!-- vignettes/benchmark-complete.Rmd is generated from .setup/vignettes/benchmark-complete.Rmd.orig. Please edit that file -->







We compare the Monte Carlo (MC) method with nonparametric bootstrapping (NB) using the simple mediation model with complete data.
One advantage of MC over NB is speed.
This is because the model is only fitted once in MC whereas it is fitted many times in NB.


```r
library(semmcci)
library(lavaan)
library(microbenchmark)
```

## Data


```r
n <- 1000
a <- 0.50
b <- 0.50
cp <- 0.25
s2_em <- 1 - a^2
s2_ey <- 1 - cp^2 - a^2 * b^2 - b^2 * s2_em - 2 * cp * a * b
em <- rnorm(n = n, mean = 0, sd = sqrt(s2_em))
ey <- rnorm(n = n, mean = 0, sd = sqrt(s2_ey))
X <- rnorm(n = n)
M <- a * X + em
Y <- cp * X + b * M + ey
df <- data.frame(X, M, Y)
```

## Model Specification

The indirect effect is defined by the product of the slopes
of paths `X` to `M` labeled as `a` and `M` to `Y` labeled as `b`.
In this example, we are interested in the confidence intervals of `indirect`
defined as the product of `a` and `b` using the `:=` operator
in the `lavaan` model syntax.


```r
model <- "
  Y ~ cp * X + b * M
  M ~ a * X
  X ~~ X
  indirect := a * b
  direct := cp
  total := cp + (a * b)
"
```

## Model Fitting

We can now fit the model using the `sem()` function from `lavaan`.


```r
fit <- sem(data = df, model = model)
```

## Monte Carlo Confidence Intervals

The `fit` `lavaan` object can then be passed to the `MC()` function from `semmcci`
to generate Monte Carlo confidence intervals.


```r
MC(fit, R = 100L, alpha = 0.05)
#> Monte Carlo Confidence Intervals
#>             est     se   R   2.5%  97.5%
#> cp       0.2333 0.0246 100 0.1823 0.2734
#> b        0.5082 0.0302 100 0.4436 0.5571
#> a        0.4820 0.0256 100 0.4330 0.5298
#> X~~X     1.0590 0.0501 100 0.9570 1.1518
#> Y~~Y     0.5462 0.0248 100 0.5018 0.6035
#> M~~M     0.7527 0.0296 100 0.6905 0.8037
#> indirect 0.2449 0.0191 100 0.2013 0.2782
#> direct   0.2333 0.0246 100 0.1823 0.2734
#> total    0.4782 0.0242 100 0.4220 0.5193
```

## Nonparametric Bootstrap Confidence Intervals

Nonparametric bootstrap confidence intervals can be generated in `lavaan` using the following.


```r
parameterEstimates(
  sem(
    data = df,
    model = model,
    se = "bootstrap",
    bootstrap = 100L
  )
)
#>        lhs op      rhs    label   est    se      z pvalue ci.lower ci.upper
#> 1        Y  ~        X       cp 0.233 0.027  8.548      0    0.185    0.297
#> 2        Y  ~        M        b 0.508 0.027 18.735      0    0.450    0.564
#> 3        M  ~        X        a 0.482 0.026 18.222      0    0.422    0.541
#> 4        X ~~        X          1.059 0.047 22.737      0    0.948    1.141
#> 5        Y ~~        Y          0.546 0.025 22.145      0    0.498    0.596
#> 6        M ~~        M          0.753 0.031 24.050      0    0.695    0.816
#> 7 indirect :=      a*b indirect 0.245 0.020 12.439      0    0.208    0.295
#> 8   direct :=       cp   direct 0.233 0.027  8.505      0    0.185    0.297
#> 9    total := cp+(a*b)    total 0.478 0.029 16.425      0    0.420    0.538
```

## Benchmark

### Arguments





|Variables |Values |Notes                               |
|:---------|:------|:-----------------------------------|
|R         |1000   |Number of Monte Carlo replications. |
|B         |1000   |Number of bootstrap samples.        |






```r
benchmark_complete_01 <- microbenchmark(
  MC = {
    fit <- sem(
      data = df,
      model = model
    )
    MC(
      fit,
      R = R,
      decomposition = "chol",
      pd = FALSE
    )
  },
  NB = sem(
    data = df,
    model = model,
    se = "bootstrap",
    bootstrap = B
  ),
  times = 10
)
```

### Summary of Benchmark Results


```r
summary(benchmark_complete_01, unit = "ms")
#>   expr        min         lq        mean     median         uq        max neval
#> 1   MC    62.5755    63.1003    64.81408    64.1373    66.5686    69.3509    10
#> 2   NB 11151.2419 11232.7201 11333.02841 11291.5490 11422.0155 11720.0967    10
```

### Summary of Benchmark Results Relative to the Faster Method


```r
summary(benchmark_complete_01, unit = "relative")
#>   expr      min       lq     mean   median       uq     max neval
#> 1   MC   1.0000   1.0000   1.0000   1.0000   1.0000   1.000    10
#> 2   NB 178.2046 178.0137 174.8544 176.0528 171.5826 168.997    10
```

## Plot

<img src="fig-vignettes-benchmark-unnamed-chunk-16-1.png" width="3300" />

## Benchmark - Monte Carlo Method with Precalculated Estimates




```r
fit <- sem(
  data = df,
  model = model
)
benchmark_complete_02 <- microbenchmark(
  MC = MC(
    fit,
    R = R,
    decomposition = "chol",
    pd = FALSE
  ),
  NB = sem(
    data = df,
    model = model,
    se = "bootstrap",
    bootstrap = B
  ),
  times = 10
)
```

### Summary of Benchmark Results


```r
summary(benchmark_complete_02, unit = "ms")
#>   expr       min         lq        mean      median        uq        max neval
#> 1   MC    18.514    18.5532    19.62139    19.11235    19.623    24.9935    10
#> 2   NB 10943.017 10984.7024 11124.19771 11137.83870 11195.728 11351.2735    10
```

### Summary of Benchmark Results Relative to the Faster Method


```r
summary(benchmark_complete_02, unit = "relative")
#>   expr      min       lq     mean   median       uq     max neval
#> 1   MC   1.0000   1.0000   1.0000   1.0000   1.0000   1.000    10
#> 2   NB 591.0671 592.0651 566.9424 582.7561 570.5411 454.169    10
```

## Plot

<img src="fig-vignettes-benchmark-unnamed-chunk-21-1.png" width="3300" />

## References
