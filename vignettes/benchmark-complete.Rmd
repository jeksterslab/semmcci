---
title: "Benchmark: Comparing the Monte Carlo Method with Nonparametric Bootstrapping"
author: "Ivan Jacob Agaloos Pesigan"
date: "2023-08-10"
bibliography: "vignettes.bib"
csl: https://raw.githubusercontent.com/citation-style-language/styles/master/apa.csl
nocite: |
  @Pesigan-Cheung-2023
output:
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{Benchmark: Comparing the Monte Carlo Method with Nonparametric Bootstrapping}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

<!-- vignettes/benchmark-complete.Rmd is generated from .setup/vignettes/benchmark-complete.Rmd.orig. Please edit that file -->







We compare the Monte Carlo (MC) method with nonparametric bootstrapping (NB) using the simple mediation model with complete data.
One advantage of MC over NB is speed.
This is because the model is only fitted once in MC whereas it is fitted many times in NB.


```r
library(semmcci)
library(lavaan)
library(microbenchmark)
```

## Data


```r
n <- 1000
a <- 0.50
b <- 0.50
cp <- 0.25
s2_em <- 1 - a^2
s2_ey <- 1 - cp^2 - a^2 * b^2 - b^2 * s2_em - 2 * cp * a * b
em <- rnorm(n = n, mean = 0, sd = sqrt(s2_em))
ey <- rnorm(n = n, mean = 0, sd = sqrt(s2_ey))
X <- rnorm(n = n)
M <- a * X + em
Y <- cp * X + b * M + ey
df <- data.frame(X, M, Y)
```

## Model Specification

The indirect effect is defined by the product of the slopes
of paths `X` to `M` labeled as `a` and `M` to `Y` labeled as `b`.
In this example, we are interested in the confidence intervals of `indirect`
defined as the product of `a` and `b` using the `:=` operator
in the `lavaan` model syntax.


```r
model <- "
  Y ~ cp * X + b * M
  M ~ a * X
  X ~~ X
  indirect := a * b
  direct := cp
  total := cp + (a * b)
"
```

## Model Fitting

We can now fit the model using the `sem()` function from `lavaan`.


```r
fit <- sem(data = df, model = model)
```

## Monte Carlo Confidence Intervals

The `fit` `lavaan` object can then be passed to the `MC()` function from `semmcci`
to generate Monte Carlo confidence intervals.


```r
MC(fit, R = 100L, alpha = 0.05)
#> Monte Carlo Confidence Intervals
#>             est     se   R   2.5%  97.5%
#> cp       0.2333 0.0271 100 0.1804 0.2786
#> b        0.5082 0.0227 100 0.4604 0.5475
#> a        0.4820 0.0263 100 0.4218 0.5240
#> X~~X     1.0590 0.0505 100 0.9704 1.1428
#> Y~~Y     0.5462 0.0256 100 0.4899 0.5911
#> M~~M     0.7527 0.0308 100 0.6929 0.8057
#> indirect 0.2449 0.0174 100 0.2100 0.2783
#> direct   0.2333 0.0271 100 0.1804 0.2786
#> total    0.4782 0.0284 100 0.4106 0.5273
```

## Nonparametric Bootstrap Confidence Intervals

Nonparametric bootstrap confidence intervals can be generated in `lavaan` using the following.


```r
parameterEstimates(
  sem(
    data = df,
    model = model,
    se = "bootstrap",
    bootstrap = 100L
  )
)
#>        lhs op      rhs    label   est    se      z pvalue ci.lower ci.upper
#> 1        Y  ~        X       cp 0.233 0.030  7.825      0    0.179    0.300
#> 2        Y  ~        M        b 0.508 0.028 17.963      0    0.448    0.558
#> 3        M  ~        X        a 0.482 0.027 17.558      0    0.426    0.535
#> 4        X ~~        X          1.059 0.041 25.573      0    0.970    1.153
#> 5        Y ~~        Y          0.546 0.023 23.493      0    0.499    0.594
#> 6        M ~~        M          0.753 0.031 23.956      0    0.684    0.820
#> 7 indirect :=      a*b indirect 0.245 0.020 12.058      0    0.205    0.282
#> 8   direct :=       cp   direct 0.233 0.030  7.786      0    0.179    0.300
#> 9    total := cp+(a*b)    total 0.478 0.031 15.652      0    0.413    0.542
```

## Benchmark

### Arguments





|Variables |Values |Notes                               |
|:---------|:------|:-----------------------------------|
|R         |1000   |Number of Monte Carlo replications. |
|B         |1000   |Number of bootstrap samples.        |






```r
benchmark_complete_01 <- microbenchmark(
  MC = {
    fit <- sem(
      data = df,
      model = model
    )
    MC(
      fit,
      R = R,
      decomposition = "chol",
      pd = FALSE
    )
  },
  NB = sem(
    data = df,
    model = model,
    se = "bootstrap",
    bootstrap = B
  ),
  times = 10
)
```

### Summary of Benchmark Results


```r
summary(benchmark_complete_01, unit = "ms")
#>   expr        min         lq        mean      median         uq        max
#> 1   MC    62.1595    64.6281    66.08792    66.30465    68.1709    68.6846
#> 2   NB 12046.9715 12245.3039 12323.76434 12314.43660 12441.1210 12608.3138
#>   neval
#> 1    10
#> 2    10
```

### Summary of Benchmark Results Relative to the Faster Method


```r
summary(benchmark_complete_01, unit = "relative")
#>   expr      min       lq     mean   median      uq      max neval
#> 1   MC   1.0000   1.0000   1.0000   1.0000   1.000   1.0000    10
#> 2   NB 193.8074 189.4734 186.4753 185.7251 182.499 183.5683    10
```

## Plot

<img src="fig-vignettes-benchmark-unnamed-chunk-16-1.png" width="3300" />

## Benchmark - Monte Carlo Method with Precalculated Estimates




```r
fit <- sem(
  data = df,
  model = model
)
benchmark_complete_02 <- microbenchmark(
  MC = MC(
    fit,
    R = R,
    decomposition = "chol",
    pd = FALSE
  ),
  NB = sem(
    data = df,
    model = model,
    se = "bootstrap",
    bootstrap = B
  ),
  times = 10
)
```

### Summary of Benchmark Results


```r
summary(benchmark_complete_02, unit = "ms")
#>   expr        min         lq        mean     median         uq        max neval
#> 1   MC    18.8038    19.2114    21.17623    19.8383    22.8205    25.6665    10
#> 2   NB 12013.4015 12039.9347 12149.07130 12115.9460 12237.8532 12424.2130    10
```

### Summary of Benchmark Results Relative to the Faster Method


```r
summary(benchmark_complete_02, unit = "relative")
#>   expr      min       lq     mean   median       uq      max neval
#> 1   MC   1.0000   1.0000   1.0000   1.0000   1.0000   1.0000    10
#> 2   NB 638.8816 626.7078 573.7127 610.7351 536.2658 484.0634    10
```

## Plot

<img src="fig-vignettes-benchmark-unnamed-chunk-21-1.png" width="3300" />

## References
