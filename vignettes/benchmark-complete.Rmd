---
title: "Benchmark: Comparing the Monte Carlo Method with Nonparametric Bootstrapping"
author: "Ivan Jacob Agaloos Pesigan"
date: "2023-08-08"
bibliography: "vignettes.bib"
csl: https://raw.githubusercontent.com/citation-style-language/styles/master/apa.csl
nocite: |
  @Pesigan-Cheung-2023
output:
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{Benchmark: Comparing the Monte Carlo Method with Nonparametric Bootstrapping}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

<!-- vignettes/benchmark-complete.Rmd is generated from .setup/vignettes/benchmark-complete.Rmd.orig. Please edit that file -->







We compare the Monte Carlo (MC) method with nonparametric bootstrapping (NB) using the simple mediation model with complete data.
One advantage of MC over NB is speed.
This is because the model is only fitted once in MC whereas it is fitted many times in NB.


```r
library(semmcci)
library(lavaan)
library(microbenchmark)
```

## Data


```r
n <- 1000
a <- 0.50
b <- 0.50
cp <- 0.25
s2_em <- 1 - a^2
s2_ey <- 1 - cp^2 - a^2 * b^2 - b^2 * s2_em - 2 * cp * a * b
em <- rnorm(n = n, mean = 0, sd = sqrt(s2_em))
ey <- rnorm(n = n, mean = 0, sd = sqrt(s2_ey))
X <- rnorm(n = n)
M <- a * X + em
Y <- cp * X + b * M + ey
df <- data.frame(X, M, Y)
```

## Model Specification

The indirect effect is defined by the product of the slopes
of paths `X` to `M` labeled as `a` and `M` to `Y` labeled as `b`.
In this example, we are interested in the confidence intervals of `indirect`
defined as the product of `a` and `b` using the `:=` operator
in the `lavaan` model syntax.


```r
model <- "
  Y ~ cp * X + b * M
  M ~ a * X
  X ~~ X
  indirect := a * b
  direct := cp
  total := cp + (a * b)
"
```

## Model Fitting

We can now fit the model using the `sem()` function from `lavaan`.


```r
fit <- sem(data = df, model = model)
```

## Monte Carlo Confidence Intervals

The `fit` `lavaan` object can then be passed to the `MC()` function from `semmcci`
to generate Monte Carlo confidence intervals.


```r
MC(fit, R = 100L, alpha = 0.05)
#> Monte Carlo Confidence Intervals
#>             est     se   R   2.5%  97.5%
#> cp       0.2333 0.0248 100 0.1886 0.2787
#> b        0.5082 0.0283 100 0.4503 0.5630
#> a        0.4820 0.0279 100 0.4274 0.5427
#> X~~X     1.0590 0.0498 100 0.9641 1.1548
#> Y~~Y     0.5462 0.0257 100 0.4985 0.5944
#> M~~M     0.7527 0.0327 100 0.6937 0.8173
#> indirect 0.2449 0.0187 100 0.2125 0.2786
#> direct   0.2333 0.0248 100 0.1886 0.2787
#> total    0.4782 0.0250 100 0.4310 0.5249
```

## Nonparametric Bootstrap Confidence Intervals

Nonparametric bootstrap confidence intervals can be generated in `lavaan` using the following.


```r
parameterEstimates(
  sem(
    data = df,
    model = model,
    se = "bootstrap",
    bootstrap = 100L
  )
)
#>        lhs op      rhs    label   est    se      z pvalue ci.lower ci.upper
#> 1        Y  ~        X       cp 0.233 0.025  9.164      0    0.187    0.295
#> 2        Y  ~        M        b 0.508 0.028 18.169      0    0.452    0.564
#> 3        M  ~        X        a 0.482 0.026 18.877      0    0.434    0.547
#> 4        X ~~        X          1.059 0.048 22.163      0    0.976    1.147
#> 5        Y ~~        Y          0.546 0.023 23.273      0    0.495    0.593
#> 6        M ~~        M          0.753 0.038 19.855      0    0.669    0.829
#> 7 indirect :=      a*b indirect 0.245 0.019 12.903      0    0.214    0.292
#> 8   direct :=       cp   direct 0.233 0.026  9.118      0    0.187    0.295
#> 9    total := cp+(a*b)    total 0.478 0.027 17.419      0    0.429    0.540
```

## Benchmark

### Arguments





|Variables |Values |Notes                               |
|:---------|:------|:-----------------------------------|
|R         |1000   |Number of Monte Carlo replications. |
|B         |1000   |Number of bootstrap samples.        |






```r
benchmark_complete_01 <- microbenchmark(
  MC = {
    fit <- sem(
      data = df,
      model = model
    )
    MC(
      fit,
      R = R,
      decomposition = "chol",
      pd = FALSE
    )
  },
  NB = sem(
    data = df,
    model = model,
    se = "bootstrap",
    bootstrap = B
  ),
  times = 10
)
```

### Summary of Benchmark Results


```r
summary(benchmark_complete_01, unit = "ms")
#>   expr        min        lq       mean     median         uq        max neval
#> 1   MC   102.8858   108.463   113.6128   109.0198   114.3633   138.7886    10
#> 2   NB 20654.1382 20836.879 21044.2463 21038.5316 21157.2158 21706.9403    10
```

### Summary of Benchmark Results Relative to the Faster Method


```r
summary(benchmark_complete_01, unit = "relative")
#>   expr      min       lq     mean   median  uq      max neval
#> 1   MC   1.0000   1.0000   1.0000   1.0000   1   1.0000    10
#> 2   NB 200.7482 192.1105 185.2277 192.9789 185 156.4029    10
```

## Plot

<img src="fig-vignettes-benchmark-unnamed-chunk-16-1.png" width="3300" />

## Benchmark - Monte Carlo Method with Precalculated Estimates




```r
fit <- sem(
  data = df,
  model = model
)
benchmark_complete_02 <- microbenchmark(
  MC = MC(
    fit,
    R = R,
    decomposition = "chol",
    pd = FALSE
  ),
  NB = sem(
    data = df,
    model = model,
    se = "bootstrap",
    bootstrap = B
  ),
  times = 10
)
```

### Summary of Benchmark Results


```r
summary(benchmark_complete_02, unit = "ms")
#>   expr        min         lq        mean     median         uq        max neval
#> 1   MC    29.3694    29.8875    34.11186    36.1878    36.6582    37.6961    10
#> 2   NB 20342.5891 20764.5836 21211.20097 21023.5131 21866.9091 22488.9941    10
```

### Summary of Benchmark Results Relative to the Faster Method


```r
summary(benchmark_complete_02, unit = "relative")
#>   expr      min       lq     mean   median      uq      max neval
#> 1   MC   1.0000   1.0000   1.0000   1.0000   1.000   1.0000    10
#> 2   NB 692.6457 694.7581 621.8131 580.9558 596.508 596.5868    10
```

## Plot

<img src="fig-vignettes-benchmark-unnamed-chunk-21-1.png" width="3300" />

## References
