---
title: "Benchmark: Comparing the Monte Carlo Method with Nonparametric Bootstrapping"
author: "Ivan Jacob Agaloos Pesigan"
date: "2023-08-08"
bibliography: "vignettes.bib"
csl: https://raw.githubusercontent.com/citation-style-language/styles/master/apa.csl
nocite: |
  @Pesigan-Cheung-2023
output:
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{Benchmark: Comparing the Monte Carlo Method with Nonparametric Bootstrapping}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

<!-- vignettes/benchmark-complete.Rmd is generated from .setup/vignettes/benchmark-complete.Rmd.orig. Please edit that file -->







We compare the Monte Carlo (MC) method with nonparametric bootstrapping (NB) using the simple mediation model with complete data.
One advantage of MC over NB is speed.
This is because the model is only fitted once in MC whereas it is fitted many times in NB.


```r
library(semmcci)
library(lavaan)
library(microbenchmark)
```

## Data


```r
n <- 1000
a <- 0.50
b <- 0.50
cp <- 0.25
s2_em <- 1 - a^2
s2_ey <- 1 - cp^2 - a^2 * b^2 - b^2 * s2_em - 2 * cp * a * b
em <- rnorm(n = n, mean = 0, sd = sqrt(s2_em))
ey <- rnorm(n = n, mean = 0, sd = sqrt(s2_ey))
X <- rnorm(n = n)
M <- a * X + em
Y <- cp * X + b * M + ey
df <- data.frame(X, M, Y)
```

## Model Specification

The indirect effect is defined by the product of the slopes
of paths `X` to `M` labeled as `a` and `M` to `Y` labeled as `b`.
In this example, we are interested in the confidence intervals of `indirect`
defined as the product of `a` and `b` using the `:=` operator
in the `lavaan` model syntax.


```r
model <- "
  Y ~ cp * X + b * M
  M ~ a * X
  X ~~ X
  indirect := a * b
  direct := cp
  total := cp + (a * b)
"
```

## Model Fitting

We can now fit the model using the `sem()` function from `lavaan`.


```r
fit <- sem(data = df, model = model)
```

## Monte Carlo Confidence Intervals

The `fit` `lavaan` object can then be passed to the `MC()` function from `semmcci`
to generate Monte Carlo confidence intervals.


```r
MC(fit, R = 100L, alpha = 0.05)
#> Monte Carlo Confidence Intervals
#>             est     se   R   2.5%  97.5%
#> cp       0.2333 0.0255 100 0.1911 0.2898
#> b        0.5082 0.0287 100 0.4493 0.5631
#> a        0.4820 0.0268 100 0.4377 0.5286
#> X~~X     1.0590 0.0457 100 0.9755 1.1525
#> Y~~Y     0.5462 0.0226 100 0.4991 0.5860
#> M~~M     0.7527 0.0325 100 0.6944 0.8108
#> indirect 0.2449 0.0186 100 0.2154 0.2836
#> direct   0.2333 0.0255 100 0.1911 0.2898
#> total    0.4782 0.0248 100 0.4394 0.5275
```

## Nonparametric Bootstrap Confidence Intervals

Nonparametric bootstrap confidence intervals can be generated in `lavaan` using the following.


```r
parameterEstimates(
  sem(
    data = df,
    model = model,
    se = "bootstrap",
    bootstrap = 100L
  )
)
#>        lhs op      rhs    label   est    se      z pvalue ci.lower ci.upper
#> 1        Y  ~        X       cp 0.233 0.029  8.049      0    0.175    0.292
#> 2        Y  ~        M        b 0.508 0.029 17.264      0    0.454    0.578
#> 3        M  ~        X        a 0.482 0.026 18.865      0    0.433    0.539
#> 4        X ~~        X          1.059 0.056 18.745      0    0.961    1.182
#> 5        Y ~~        Y          0.546 0.024 23.195      0    0.501    0.590
#> 6        M ~~        M          0.753 0.034 22.282      0    0.684    0.830
#> 7 indirect :=      a*b indirect 0.245 0.018 13.239      0    0.209    0.289
#> 8   direct :=       cp   direct 0.233 0.029  8.009      0    0.175    0.292
#> 9    total := cp+(a*b)    total 0.478 0.027 17.894      0    0.431    0.531
```

## Benchmark

### Arguments





|Variables |Values |Notes                               |
|:---------|:------|:-----------------------------------|
|R         |1000   |Number of Monte Carlo replications. |
|B         |1000   |Number of bootstrap samples.        |






```r
benchmark_complete_01 <- microbenchmark(
  MC = {
    fit <- sem(
      data = df,
      model = model
    )
    MC(
      fit,
      R = R,
      decomposition = "chol",
      pd = FALSE
    )
  },
  NB = sem(
    data = df,
    model = model,
    se = "bootstrap",
    bootstrap = B
  ),
  times = 10
)
```

### Summary of Benchmark Results


```r
summary(benchmark_complete_01, unit = "ms")
#>   expr        min         lq        mean     median         uq       max neval
#> 1   MC    65.4614    70.8684    72.08987    72.7679    74.0041    75.523    10
#> 2   NB 12567.2648 12855.8866 13029.84416 13126.1459 13173.9742 13404.046    10
```

### Summary of Benchmark Results Relative to the Faster Method


```r
summary(benchmark_complete_01, unit = "relative")
#>   expr      min       lq     mean   median       uq     max neval
#> 1   MC   1.0000   1.0000   1.0000   1.0000   1.0000   1.000    10
#> 2   NB 191.9798 181.4051 180.7445 180.3837 178.0168 177.483    10
```

## Plot

<img src="fig-vignettes-benchmark-unnamed-chunk-16-1.png" width="3300" />

## Benchmark - Monte Carlo Method with Precalculated Estimates




```r
fit <- sem(
  data = df,
  model = model
)
benchmark_complete_02 <- microbenchmark(
  MC = MC(
    fit,
    R = R,
    decomposition = "chol",
    pd = FALSE
  ),
  NB = sem(
    data = df,
    model = model,
    se = "bootstrap",
    bootstrap = B
  ),
  times = 10
)
```

### Summary of Benchmark Results


```r
summary(benchmark_complete_02, unit = "ms")
#>   expr        min        lq        mean      median         uq        max neval
#> 1   MC    21.9404    22.259    25.22531    24.96365    27.7767    30.9966    10
#> 2   NB 12601.0671 13120.043 13187.47688 13283.42140 13301.2469 13420.8077    10
```

### Summary of Benchmark Results Relative to the Faster Method


```r
summary(benchmark_complete_02, unit = "relative")
#>   expr      min       lq     mean   median       uq      max neval
#> 1   MC   1.0000   1.0000   1.0000   1.0000   1.0000   1.0000    10
#> 2   NB 574.3317 589.4264 522.7875 532.1105 478.8635 432.9768    10
```

## Plot

<img src="fig-vignettes-benchmark-unnamed-chunk-21-1.png" width="3300" />

## References
