---
title: "Benchmark: Comparing the Monte Carlo Method with Nonparametric Bootstrapping"
author: "Ivan Jacob Agaloos Pesigan"
date: "2023-08-08"
bibliography: "vignettes.bib"
csl: https://raw.githubusercontent.com/citation-style-language/styles/master/apa.csl
nocite: |
  @Pesigan-Cheung-2023
output:
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{Benchmark: Comparing the Monte Carlo Method with Nonparametric Bootstrapping}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

<!-- vignettes/benchmark-complete.Rmd is generated from .setup/vignettes/benchmark-complete.Rmd.orig. Please edit that file -->







We compare the Monte Carlo (MC) method with nonparametric bootstrapping (NB) using the simple mediation model with complete data.
One advantage of MC over NB is speed.
This is because the model is only fitted once in MC whereas it is fitted many times in NB.


```r
library(semmcci)
library(lavaan)
library(microbenchmark)
```

## Data


```r
n <- 1000
a <- 0.50
b <- 0.50
cp <- 0.25
s2_em <- 1 - a^2
s2_ey <- 1 - cp^2 - a^2 * b^2 - b^2 * s2_em - 2 * cp * a * b
em <- rnorm(n = n, mean = 0, sd = sqrt(s2_em))
ey <- rnorm(n = n, mean = 0, sd = sqrt(s2_ey))
X <- rnorm(n = n)
M <- a * X + em
Y <- cp * X + b * M + ey
df <- data.frame(X, M, Y)
```

## Model Specification

The indirect effect is defined by the product of the slopes
of paths `X` to `M` labeled as `a` and `M` to `Y` labeled as `b`.
In this example, we are interested in the confidence intervals of `indirect`
defined as the product of `a` and `b` using the `:=` operator
in the `lavaan` model syntax.


```r
model <- "
  Y ~ cp * X + b * M
  M ~ a * X
  X ~~ X
  indirect := a * b
  direct := cp
  total := cp + (a * b)
"
```

## Model Fitting

We can now fit the model using the `sem()` function from `lavaan`.


```r
fit <- sem(data = df, model = model)
```

## Monte Carlo Confidence Intervals

The `fit` `lavaan` object can then be passed to the `MC()` function from `semmcci`
to generate Monte Carlo confidence intervals.


```r
MC(fit, R = 100L, alpha = 0.05)
#> Monte Carlo Confidence Intervals
#>             est     se   R   2.5%  97.5%
#> cp       0.2333 0.0241 100 0.1897 0.2790
#> b        0.5082 0.0297 100 0.4464 0.5603
#> a        0.4820 0.0268 100 0.4292 0.5275
#> X~~X     1.0590 0.0515 100 0.9587 1.1619
#> Y~~Y     0.5462 0.0234 100 0.5032 0.5858
#> M~~M     0.7527 0.0321 100 0.6901 0.8086
#> indirect 0.2449 0.0201 100 0.2087 0.2816
#> direct   0.2333 0.0241 100 0.1897 0.2790
#> total    0.4782 0.0262 100 0.4282 0.5315
```

## Nonparametric Bootstrap Confidence Intervals

Nonparametric bootstrap confidence intervals can be generated in `lavaan` using the following.


```r
parameterEstimates(
  sem(
    data = df,
    model = model,
    se = "bootstrap",
    bootstrap = 100L
  )
)
#>        lhs op      rhs    label   est    se      z pvalue ci.lower ci.upper
#> 1        Y  ~        X       cp 0.233 0.029  7.992      0    0.173    0.291
#> 2        Y  ~        M        b 0.508 0.026 19.278      0    0.455    0.567
#> 3        M  ~        X        a 0.482 0.028 17.060      0    0.416    0.537
#> 4        X ~~        X          1.059 0.042 25.167      0    0.984    1.149
#> 5        Y ~~        Y          0.546 0.023 23.249      0    0.498    0.588
#> 6        M ~~        M          0.753 0.033 22.524      0    0.672    0.819
#> 7 indirect :=      a*b indirect 0.245 0.019 13.024      0    0.212    0.283
#> 8   direct :=       cp   direct 0.233 0.029  7.952      0    0.173    0.291
#> 9    total := cp+(a*b)    total 0.478 0.032 15.109      0    0.413    0.541
```

## Benchmark

### Arguments





|Variables |Values |Notes                               |
|:---------|:------|:-----------------------------------|
|R         |1000   |Number of Monte Carlo replications. |
|B         |1000   |Number of bootstrap samples.        |






```r
benchmark_complete_01 <- microbenchmark(
  MC = {
    fit <- sem(
      data = df,
      model = model
    )
    MC(
      fit,
      R = R,
      decomposition = "chol",
      pd = FALSE
    )
  },
  NB = sem(
    data = df,
    model = model,
    se = "bootstrap",
    bootstrap = B
  ),
  times = 10
)
```

### Summary of Benchmark Results


```r
summary(benchmark_complete_01, unit = "ms")
#>   expr        min         lq        mean      median         uq        max
#> 1   MC    65.3722    65.8291    66.76137    66.32675    67.4455    70.1746
#> 2   NB 11741.5678 11793.9952 11844.39793 11867.91155 11884.0999 11951.7377
#>   neval
#> 1    10
#> 2    10
```

### Summary of Benchmark Results Relative to the Faster Method


```r
summary(benchmark_complete_01, unit = "relative")
#>   expr     min       lq     mean  median      uq      max neval
#> 1   MC   1.000   1.0000   1.0000   1.000   1.000   1.0000    10
#> 2   NB 179.611 179.1608 177.4139 178.931 176.203 170.3143    10
```

## Plot

<img src="fig-vignettes-benchmark-unnamed-chunk-16-1.png" width="3300" />

## Benchmark - Monte Carlo Method with Precalculated Estimates




```r
fit <- sem(
  data = df,
  model = model
)
benchmark_complete_02 <- microbenchmark(
  MC = MC(
    fit,
    R = R,
    decomposition = "chol",
    pd = FALSE
  ),
  NB = sem(
    data = df,
    model = model,
    se = "bootstrap",
    bootstrap = B
  ),
  times = 10
)
```

### Summary of Benchmark Results


```r
summary(benchmark_complete_02, unit = "ms")
#>   expr        min         lq       mean     median         uq        max neval
#> 1   MC    18.8116    18.9055    20.1862    19.5254    21.3941    23.1074    10
#> 2   NB 11582.3359 11628.6235 11691.1601 11690.7005 11726.3034 11867.7724    10
```

### Summary of Benchmark Results Relative to the Faster Method


```r
summary(benchmark_complete_02, unit = "relative")
#>   expr      min       lq    mean   median       uq      max neval
#> 1   MC   1.0000   1.0000   1.000   1.0000   1.0000   1.0000    10
#> 2   NB 615.7018 615.0921 579.166 598.7432 548.1092 513.5919    10
```

## Plot

<img src="fig-vignettes-benchmark-unnamed-chunk-21-1.png" width="3300" />

## References
