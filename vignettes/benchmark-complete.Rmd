---
title: "Benchmark: Comparing the Monte Carlo Method with Nonparametric Bootstrapping"
author: "Ivan Jacob Agaloos Pesigan"
date: "2023-08-15"
bibliography: "vignettes.bib"
csl: https://raw.githubusercontent.com/citation-style-language/styles/master/apa.csl
nocite: |
  @Pesigan-Cheung-2023
output:
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{Benchmark: Comparing the Monte Carlo Method with Nonparametric Bootstrapping}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

<!-- vignettes/benchmark-complete.Rmd is generated from .setup/vignettes/benchmark-complete.Rmd.orig. Please edit that file -->







We compare the Monte Carlo (MC) method with nonparametric bootstrapping (NB) using the simple mediation model with complete data.
One advantage of MC over NB is speed.
This is because the model is only fitted once in MC whereas it is fitted many times in NB.


```r
library(semmcci)
library(lavaan)
library(microbenchmark)
```

## Data


```r
n <- 1000
a <- 0.50
b <- 0.50
cp <- 0.25
s2_em <- 1 - a^2
s2_ey <- 1 - cp^2 - a^2 * b^2 - b^2 * s2_em - 2 * cp * a * b
em <- rnorm(n = n, mean = 0, sd = sqrt(s2_em))
ey <- rnorm(n = n, mean = 0, sd = sqrt(s2_ey))
X <- rnorm(n = n)
M <- a * X + em
Y <- cp * X + b * M + ey
df <- data.frame(X, M, Y)
```

## Model Specification

The indirect effect is defined by the product of the slopes
of paths `X` to `M` labeled as `a` and `M` to `Y` labeled as `b`.
In this example, we are interested in the confidence intervals of `indirect`
defined as the product of `a` and `b` using the `:=` operator
in the `lavaan` model syntax.


```r
model <- "
  Y ~ cp * X + b * M
  M ~ a * X
  X ~~ X
  indirect := a * b
  direct := cp
  total := cp + (a * b)
"
```

## Model Fitting

We can now fit the model using the `sem()` function from `lavaan`.


```r
fit <- sem(data = df, model = model)
```

## Monte Carlo Confidence Intervals

The `fit` `lavaan` object can then be passed to the `MC()` function from `semmcci`
to generate Monte Carlo confidence intervals.


```r
MC(fit, R = 100L, alpha = 0.05)
#> Monte Carlo Confidence Intervals
#>             est     se   R   2.5%  97.5%
#> cp       0.2333 0.0263 100 0.1812 0.2834
#> b        0.5082 0.0285 100 0.4525 0.5683
#> a        0.4820 0.0270 100 0.4239 0.5298
#> X~~X     1.0590 0.0480 100 0.9713 1.1517
#> Y~~Y     0.5462 0.0213 100 0.5045 0.5885
#> M~~M     0.7527 0.0328 100 0.6905 0.8164
#> indirect 0.2449 0.0181 100 0.2065 0.2800
#> direct   0.2333 0.0263 100 0.1812 0.2834
#> total    0.4782 0.0279 100 0.4227 0.5285
```

## Nonparametric Bootstrap Confidence Intervals

Nonparametric bootstrap confidence intervals can be generated in `lavaan` using the following.


```r
parameterEstimates(
  sem(
    data = df,
    model = model,
    se = "bootstrap",
    bootstrap = 100L
  )
)
#>        lhs op      rhs    label   est    se      z pvalue ci.lower ci.upper
#> 1        Y  ~        X       cp 0.233 0.030  7.893      0    0.172    0.286
#> 2        Y  ~        M        b 0.508 0.031 16.434      0    0.444    0.564
#> 3        M  ~        X        a 0.482 0.027 17.714      0    0.429    0.543
#> 4        X ~~        X          1.059 0.047 22.375      0    0.965    1.160
#> 5        Y ~~        Y          0.546 0.024 22.577      0    0.492    0.596
#> 6        M ~~        M          0.753 0.037 20.159      0    0.676    0.829
#> 7 indirect :=      a*b indirect 0.245 0.022 11.035      0    0.200    0.293
#> 8   direct :=       cp   direct 0.233 0.030  7.853      0    0.172    0.286
#> 9    total := cp+(a*b)    total 0.478 0.031 15.505      0    0.415    0.536
```

## Benchmark

### Arguments





|Variables |Values |Notes                               |
|:---------|:------|:-----------------------------------|
|R         |1000   |Number of Monte Carlo replications. |
|B         |1000   |Number of bootstrap samples.        |






```r
benchmark_complete_01 <- microbenchmark(
  MC = {
    fit <- sem(
      data = df,
      model = model
    )
    MC(
      fit,
      R = R,
      decomposition = "chol",
      pd = FALSE
    )
  },
  NB = sem(
    data = df,
    model = model,
    se = "bootstrap",
    bootstrap = B
  ),
  times = 10
)
```

### Summary of Benchmark Results


```r
summary(benchmark_complete_01, unit = "ms")
#>   expr        min         lq       mean     median         uq        max neval
#> 1   MC   106.6874   110.3883   116.9985   113.2686   125.7365   129.6399    10
#> 2   NB 22685.3204 22696.6022 23018.9336 22951.1675 23313.0841 23597.3503    10
```

### Summary of Benchmark Results Relative to the Faster Method


```r
summary(benchmark_complete_01, unit = "relative")
#>   expr      min      lq     mean   median       uq      max neval
#> 1   MC   1.0000   1.000   1.0000   1.0000   1.0000   1.0000    10
#> 2   NB 212.6335 205.607 196.7456 202.6261 185.4122 182.0223    10
```

## Plot

<img src="fig-vignettes-benchmark-unnamed-chunk-16-1.png" width="3300" />

## Benchmark - Monte Carlo Method with Precalculated Estimates




```r
fit <- sem(
  data = df,
  model = model
)
benchmark_complete_02 <- microbenchmark(
  MC = MC(
    fit,
    R = R,
    decomposition = "chol",
    pd = FALSE
  ),
  NB = sem(
    data = df,
    model = model,
    se = "bootstrap",
    bootstrap = B
  ),
  times = 10
)
```

### Summary of Benchmark Results


```r
summary(benchmark_complete_02, unit = "ms")
#>   expr        min         lq        mean     median         uq        max neval
#> 1   MC    33.5197    36.4781    39.06172    37.3875    41.8001    47.4104    10
#> 2   NB 22771.9835 22908.8038 23275.45817 23120.2764 23475.6169 24236.8756    10
```

### Summary of Benchmark Results Relative to the Faster Method


```r
summary(benchmark_complete_02, unit = "relative")
#>   expr      min       lq     mean   median       uq      max neval
#> 1   MC   1.0000   1.0000   1.0000   1.0000   1.0000   1.0000    10
#> 2   NB 679.3612 628.0153 595.8636 618.3959 561.6163 511.2143    10
```

## Plot

<img src="fig-vignettes-benchmark-unnamed-chunk-21-1.png" width="3300" />

## References
